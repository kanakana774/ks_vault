## PostgreSQL 問題集（Netflix エンゲージメントレポートデータ）

- 環境変数設定（されてなければ）

> C:\Program Files\PostgreSQL\17\bin

---

- ターミナルを立ち上げて、sql ファイルがある場所までディレクトリを移動する（win+x）

> cd sql ファイルのあるディレクトリパス

- ローカルの sql サーバーに接続する（パスワードは aevic のはず）

> psql -h localhost -p 5432 -U postgres -d postgres

- データベース作成

> CREATE DATABASE mydb;

- データベースの一覧を確認する

> \l

- 新しいデータベースに接続する

> \c mydb

- sql ファイルを流し込む

> \i Chinook_PostgreSql_SerialPKs.sql

- 接続を切る

> \q

---

### 問題 1: 2024 年上半期に最も視聴された映画

2024 年 1 月から 6 月の期間（`duration = 'SEMI_ANNUALLY'`）で、最も視聴時間（`hours_viewed`）が長かった映画のタイトルと視聴時間を取得してください。

**回答:**

---

### 問題 2: グローバルで利用可能な映画の平均ランタイム

グローバルで利用可能（`available_globally = TRUE`）な映画の平均ランタイム（`runtime`）を、小数点以下を切り捨てて整数で取得してください。

**回答:**

**ヒント:** 平均値を整数に変換するには `FLOOR()` 関数を使用します。

---

### 問題 3: 各月の視聴時間の合計（映画と TV 番組を区別せず）

2024 年 1 月から 6 月までの各月における、映画と TV 番組（シーズン）を合わせた総視聴時間（`hours_viewed`）を月ごとに集計してください。月のフォーマットは `YYYY-MM` としてください。

**回答:**

**ヒント:** 日付から年と月を抽出するには `TO_CHAR()` 関数を使用します。

---

### 問題 4: 視聴時間トップ 5 の映画と、その映画がリリースされてからの経過日数

2024 年上半期のデータで視聴時間（`hours_viewed`）がトップ 5 の映画タイトルと、その映画のリリース日（`release_date`）から 2024 年 6 月 30 日までの経過日数（日数）をそれぞれ取得してください。

**回答:**

---

### 問題 5: 各 TV 番組のシーズンごとの平均ランタイム

各 TV 番組について、その番組に属する各シーズン（`season`テーブル）の平均ランタイムを算出し、TV 番組のタイトル、シーズンタイトル、平均ランタイムを表示してください。ただし、ランタイムが 0 のシーズンは除外してください。

**回答:**

---

### 問題 6: 視聴時間が平均より高い映画のリスト

2024 年上半期に登録された映画の中で、全体の平均視聴時間よりも視聴時間が長い映画のタイトルと視聴時間を取得してください。

**回答:**

---

### 問題 7: 各 TV 番組で最も視聴時間の長いシーズン

各 TV 番組について、最も視聴時間（`hours_viewed`）が長いシーズンのタイトルとその視聴時間を取得してください。TV 番組のタイトルも表示してください。
（2024 年上半期データを使用）

**回答:**

**ヒント:** `ROW_NUMBER()` 関数と `PARTITION BY` を使用して、各 TV 番組内でシーズンをランク付けします。

---

### 問題 8: 2024 年上半期にトップ 10 入りした映画と TV 番組の合計数

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）に`view_rank`が 10 以内に入った映画と TV 番組（シーズン）のユニークなタイトルの合計数を取得してください。

**回答:**

---

### 問題 9: リリース日が最も古いトップ 10 映画

2024 年上半期に視聴された映画の中で、`view_rank`が 10 以内に入った映画のうち、リリース日（`release_date`）が最も古い映画のタイトルとリリース日を取得してください。

**回答:**

---

### 問題 10: 各月の視聴時間の前月比（映画のみ）

2024 年 1 月から 6 月までの各月における映画の総視聴時間と、その前月からの視聴時間の変化率（パーセンテージ）を計算してください。最初の月は NULL を表示してください。

**回答:**

**ヒント:** `LAG()` 関数と `OVER (ORDER BY ...)` を使用して前月の値を取得します。パーセンテージ計算には `::NUMERIC` で型キャストが必要です。

---

### 問題 11: 各映画のグローバル利用可能性と視聴時間の関係

各映画について、その映画がグローバルで利用可能かどうか（`available_globally`）と、2024 年上半期の総視聴時間（`hours_viewed`）を一覧表示してください。グローバルで利用可能な映画とそうでない映画の視聴時間を比較しやすいように並び替えてください。

**回答:**

**ヒント:** `COALESCE()` 関数を使って NULL 値を別の値に置き換えられます。

---

### 問題 12: 各 TV 番組の最も新しいシーズンと最も古いシーズンのリリース日

各 TV 番組について、最も新しいシーズンのリリース日と最も古いシーズンのリリース日を取得してください。

**回答:**

---

### 問題 13: 視聴時間が特定の範囲内にある映画のタイトルとランタイム

2024 年上半期の視聴時間（`hours_viewed`）が 1000 万時間以上 2000 万時間未満の映画のタイトルとランタイム（`runtime`）を取得してください。

**回答:**

---

### 問題 14: 同じリリース日を持つ映画の数

同じリリース日を持つ映画が複数ある場合、そのリリース日と、その日にリリースされた映画の数を取得してください。

**回答:**

---

### 問題 15: グローバルで利用可能な映画とそうでない映画のトップ 10 視聴時間比較

グローバルで利用可能な映画の中から視聴時間トップ 10 と、そうでない映画の中から視聴時間トップ 10 をそれぞれ取得し、一つの結果セットとして結合してください。各映画がグローバルで利用可能かどうかの情報も含めてください。

**回答:**

---

### 問題 16: 各 TV 番組の平均視聴時間（シーズン単位）と、その TV 番組で最も視聴されたシーズンの視聴時間

各 TV 番組について、その全てのシーズンの平均視聴時間と、最も視聴されたシーズンの視聴時間を取得してください。TV 番組のタイトルも表示してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 17: 累積週数が 5 週以上トップ 10 にランクインした映画のタイトルと累積週数

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、`cumulative_weeks_in_top10`が 5 週以上である映画のタイトルと累積週数を取得してください。

**回答:**

---

### 問題 18: 映画と TV 番組（シーズン）それぞれの総視聴時間ランキングトップ 3

映画と TV 番組（シーズン）でそれぞれ総視聴時間（`hours_viewed`）のランキングトップ 3 を取得し、コンテンツのタイプ（'Movie'または'Season'）を区別して表示してください。
（2024 年上半期データを使用）

**回答:**

**別パターン:**

---

### 問題 19: 各言語圏（locale）における平均ランタイムの映画トップ 3

各`locale`において、ランタイム（`runtime`）が長い映画のトップ 3 のタイトル、ランタイム、およびその`locale`を取得してください。

**回答:**

---

### 問題 20: 2024 年上半期にトップ 10 入りしたが、累積週数が 0 の映画

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、`view_rank`が 10 以内に入っているにも関わらず、`cumulative_weeks_in_top10`が 0 である映画のタイトルを取得してください。

**回答:**

---

### 問題 21: 各 TV 番組の最も視聴されたシーズンとその次のシーズンの視聴時間の差

各 TV 番組について、最も視聴時間（`hours_viewed`）が長いシーズンと、その次に視聴時間が長いシーズンの視聴時間の差を計算してください。
（2024 年上半期データを使用）

**回答:**

**ヒント:** 自己結合と`ROW_NUMBER()`を使って、各 TV 番組のトップ 2 のシーズンを取得します。

---

### 問題 22: 視聴回数（`views`）が平均以上の映画と、平均以下の TV 番組

2024 年上半期データで、視聴回数（`views`）が映画全体の平均視聴回数以上である映画のタイトルと、視聴回数が TV 番組（シーズン）全体の平均視聴回数以下である TV 番組（シーズン）のタイトルをそれぞれ取得し、一つの結果セットに統合してください。
コンテンツの種類（'Movie' or 'Season'）も表示してください。

**回答:**

---

### 問題 23: 各映画の視聴時間が、その映画がリリースされた年の平均視聴時間と比較してどうか

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、各映画の視聴時間（`hours_viewed`）とその映画がリリースされた年の全ての映画の平均視聴時間を比較して、その差を表示してください。

**回答:**

**ヒント:** `EXTRACT(YEAR FROM date_column)` で日付から年を取得できます。

---

### 問題 24: 各映画の視聴時間の累計（リリース日順）

各映画について、その映画のリリース日順に視聴時間（`hours_viewed`）の累計を計算してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 25: 2024 年上半期に最も多くの映画がリリースされた月

2024 年 1 月から 6 月までの期間で、最も多くの映画がリリースされた月とその数を取得してください。
（`release_date`を使用）

**回答:**

---

### 問題 26: グローバルで利用可能かつランタイムが平均以上の映画

グローバルで利用可能（`available_globally = TRUE`）であり、かつ全体の映画の平均ランタイム（`runtime`）よりもランタイムが長い映画のタイトルとランタイムを取得してください。

**回答:**

---

### 問題 27: 各 TV 番組の最も視聴されたシーズンのタイトルと、その TV 番組が持つ全シーズンの数

各 TV 番組について、最も視聴時間（`hours_viewed`）が長かったシーズンのタイトルと、その TV 番組に存在する全シーズンの数を取得してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 28: 映画と TV 番組（シーズン）の中で、ランタイムが最も長いコンテンツと短いコンテンツ

全映画と全シーズンの中で、最もランタイム（`runtime`）が長いコンテンツのタイトルとランタイム、および最も短いコンテンツのタイトルとランタイムをそれぞれ取得してください。コンテンツの種類（'Movie' or 'Season'）も表示してください。

**回答:**

---

### 問題 29: 各 TV 番組のシーズンごとの視聴時間と、その TV 番組内での視聴時間ランキング

各 TV 番組について、各シーズンの視聴時間（`hours_viewed`）と、その TV 番組内での視聴時間のランキング（同順位がある場合は次の順位をスキップしない`RANK()`）を取得してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 30: 2024 年上半期にトップ 10 入りした映画のうち、リリースから 1 年以内の映画

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）に`view_rank`が 10 以内に入った映画の中で、2024 年 6 月 30 日時点でリリースから 1 年以内（365 日以内）の映画のタイトルとリリース日、視聴時間を取得してください。

**回答:**

---

### 問題 31: 各 TV 番組のシーズン数が平均以上の TV 番組

全ての TV 番組のシーズン数の平均を算出し、その平均よりも多くのシーズンを持つ TV 番組のタイトルとシーズン数を取得してください。

**回答:**

---

### 問題 32: オリジナルタイトルと通常のタイトルが異なる映画のリスト

`original_title`と`title`が異なる映画のタイトル、オリジナルタイトル、ランタイムを取得してください。

**回答:**

---

### 問題 33: 2024 年上半期に視聴回数（`views`）の総和が最も高かった週

2024 年 1 月から 6 月までの週ごとのデータ（`duration = 'WEEKLY'`）で、視聴回数（`views`）の総和が最も高かった週の`start_date`と`end_date`、そして総視聴回数を取得してください。

**回答:**

---

### 問題 34: 各映画の視聴回数と、その映画が属する view_summary テーブルの行数

各映画について、2024 年上半期（`duration = 'SEMI_ANNUALLY'`）の視聴回数（`views`）と、その映画が`view_summary`テーブルに登場する回数を取得してください。

**回答:**

---

### 問題 35: 映画と TV 番組（シーズン）の中で、2024 年上半期に一度もトップ 10 に入らなかったコンテンツ

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、`view_rank`が一度も 10 以内に入らなかった映画と TV 番組（シーズン）のタイトルをそれぞれ取得し、結合して表示してください。
コンテンツの種類（'Movie' or 'Season'）も表示してください。

**回答:**

---

### 問題 36: 各月の視聴時間と累積視聴時間（TV 番組シーズンのみ）

2024 年 1 月から 6 月までの各月における TV 番組（シーズン）の総視聴時間と、その時点までの累積視聴時間を月ごとに取得してください。

**回答:**

---

### 問題 37: 視聴回数がそのカテゴリ（映画または TV 番組シーズン）の平均視聴回数を上回るコンテンツ

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、映画であれば映画全体の平均視聴回数（`views`）を、TV 番組シーズンであれば TV 番組シーズン全体の平均視聴回数を上回るコンテンツのタイトル、視聴回数、コンテンツタイプ（'Movie'または'Season'）を取得してください。

**回答:**

---

### 問題 38: 各月にリリースされた映画の数と、その月までのリリースされた映画の累積数

2024 年 1 月から 6 月までの各月において、その月にリリースされた映画の数と、その月までのリリースされた映画の累積数を取得してください。

**回答:**

---

### 問題 39: 各 TV 番組のシーズンごとの`view_rank`と、その TV 番組内で最も高い`view_rank`の差

各 TV 番組について、各シーズンの`view_rank`と、その TV 番組内で最も高い`view_rank`（数値が小さいほど高い）との差を計算してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 40: 視聴回数が偶数である映画と、視聴回数が奇数である TV 番組シーズン

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、視聴回数（`views`）が偶数である映画のタイトルと、視聴回数が奇数である TV 番組（シーズン）のタイトルをそれぞれ取得し、コンテンツの種類（'Movie'または'Season'）も表示して結合してください。

**回答:**

**ヒント:** `%`演算子で剰余を計算できます。

---

### 問題 41: 各月の`cumulative_weeks_in_top10`の合計と、その前月との差（映画のみ）

2024 年 1 月から 6 月までの各月における映画の`cumulative_weeks_in_top10`の合計と、その前月との差を計算してください。最初の月は NULL を表示してください。

**回答:**

---

### 問題 42: ランタイムが短い映画トップ 5 と、ランタイムが長い TV 番組シーズンワースト 5

ランタイム（`runtime`）が最も短い映画トップ 5 のタイトルとランタイム、およびランタイムが最も長い TV 番組シーズンワースト 5（つまり短い方から 5 つ）のタイトルとランタイムをそれぞれ取得し、一つの結果セットとして結合してください。コンテンツの種類（'Movie' or 'Season'）も表示してください。

**回答:**

---

### 問題 43: 各 TV 番組の最も古いリリース日のシーズンと、そのシーズンのリリースから現在までの経過日数

各 TV 番組について、最も古いリリース日を持つシーズンのタイトルとリリース日、そしてそのリリース日から 2024 年 6 月 30 日までの経過日数（日数）を取得してください。

**回答:**

---

### 問題 44: 2024 年上半期にトップ 10 入りした映画の平均ランタイムと、トップ 10 入りしなかった映画の平均ランタイム

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、`view_rank`が 10 以内に入った映画の平均ランタイムと、10 以内に入らなかった映画の平均ランタイムをそれぞれ取得してください。

**回答:**

---

### 問題 45: 各 TV 番組のシーズンごとのリリース日と、その TV 番組内でリリース日順に何番目のシーズンか

各 TV 番組について、各シーズンのリリース日と、その TV 番組内でリリース日が早い順に何番目のシーズンであるか（`season_number`ではない）を取得してください。

**回答:**

---

### 問題 46: 2024 年上半期に視聴時間（`hours_viewed`）が合計で 1 億時間を超えた映画と TV 番組（シーズン）

2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで、視聴時間（`hours_viewed`）の合計が 1 億時間を超えた映画と TV 番組（シーズン）のタイトル、およびその合計視聴時間を取得してください。コンテンツの種類（'Movie' or 'Season'）も表示してください。

**回答:**

---

### 問題 47: 各月の視聴回数（`views`）と、その月における最大視聴回数と最小視聴回数（映画のみ）

2024 年 1 月から 6 月までの各月において、映画の総視聴回数（`views`）と、その月に記録された映画の最大視聴回数、最小視聴回数を取得してください。

**回答:**

---

### 問題 48: グローバルで利用可能な TV 番組と、そうでない TV 番組の総視聴時間（シーズン単位）の比較

グローバルで利用可能（`available_globally = TRUE`）な TV 番組の全シーズンの総視聴時間と、そうでない TV 番組の全シーズンの総視聴時間をそれぞれ取得して比較してください。
（2024 年上半期データを使用）

**回答:**

---

### 問題 49: 2024 年上半期にトップ 10 にランクインした回数が最も多い映画

2024 年上半期（`duration = 'WEEKLY'`）のデータで、`view_rank`が 10 以内に入った回数が最も多い映画のタイトルと、その回数を取得してください。

**回答:**

---

### 問題 50: 映画と TV 番組（シーズン）全体で、最も視聴時間が多いコンテンツと最も視聴回数が多いコンテンツ

全映画と全シーズンを合わせた中で、2024 年上半期（`duration = 'SEMI_ANNUALLY'`）のデータで最も視聴時間（`hours_viewed`）が多かったコンテンツと、最も視聴回数（`views`）が多かったコンテンツのタイトル、値、コンテンツタイプをそれぞれ取得してください。

**回答:**

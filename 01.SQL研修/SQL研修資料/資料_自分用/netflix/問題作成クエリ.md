下記ロードマップで PL/pgSQL の学習用材を作成します。

### ステージ 1: PL/pgSQL の基礎

このステージでは、PL/pgSQL を理解し、簡単なスクリプトを作成するための基本を学びます。

1.  **PL/pgSQL の概要**

    - PL/pgSQL とは何か
    - なぜ PL/pgSQL を使うのか（メリット、用途）
    - 他のプログラミング言語との比較
    - PostgreSQL の関数・プロシージャとの関係
    - PL/pgSQL の基本的な構造 (DO ブロック)
    - `psql` での実行方法
    - PgAdmin など GUI ツールでの実行方法

2.  **基本的な構文と制御構造**

    - **ブロック構造**
      - `DECLARE` セクション
      - `BEGIN ... END` ブロック
      - ラベル (オプション)
    - **変数**
      - 変数の宣言 (`DECLARE variable_name data_type [DEFAULT value];`)
      - データ型 (INTEGER, TEXT, BOOLEAN, DATE など)
      - `%TYPE` (テーブル列のデータ型を参照)
      - `%ROWTYPE` (テーブル行全体のデータ型を参照)
      - 変数の代入 (`variable := expression;`)
    - **コメント**
      - 単一行コメント (`--`)
      - 複数行コメント (`/* ... */`)
    - **条件分岐**
      - `IF ... THEN ... END IF;`
      - `IF ... THEN ... ELSE ... END IF;`
      - `IF ... THEN ... ELSIF ... ELSE ... END IF;`
      - `CASE` 文 (単純な CASE, 検索 CASE)
    - **ループ**
      - `LOOP ... EXIT WHEN condition; ... END LOOP;`
      - `WHILE condition LOOP ... END LOOP;`
      - `FOR variable IN [REVERSE] start .. end LOOP ... END LOOP;` (数値範囲ループ)
      - `FOR record_var IN query LOOP ... END LOOP;` (カーソルループ)
    - **NULL の扱い**
      - `IS NULL`, `IS NOT NULL`
      - `NULL` の伝播

3.  **SQL との連携**

    - **SELECT INTO**
      - 単一行の結果を変数に格納 (`SELECT column INTO variable FROM table WHERE condition;`)
      - 複数行の結果を処理する方法 (カーソル、FOR ループ)
    - **INSERT, UPDATE, DELETE**
      - PL/pgSQL スクリプト内での実行
      - 影響を受けた行数の取得 (`GET DIAGNOSTICS variable = ROW_COUNT;`)
    - **EXECUTE (動的 SQL)**
      - SQL 文字列の構築
      - パラメータの渡し方 (`USING` 句)
      - セキュリティ上の注意点 (SQL インジェクション対策)

4.  **関数とプロシージャ**
    - **関数の作成 (`CREATE FUNCTION`)**
      - 引数と戻り値の定義
      - `RETURNS data_type`, `RETURNS TABLE`, `RETURNS SETOF record/data_type`
      - `LANGUAGE plpgsql`
      - `IMMUTABLE`, `STABLE`, `VOLATILE` (関数の特性)
      - `SECURITY DEFINER`, `SECURITY INVOKER` (セキュリティ設定)
    - **プロシージャの作成 (`CREATE PROCEDURE`)**
      - 引数 (`IN`, `OUT`, `INOUT`)
      - トランザクション制御 (COMMIT, ROLLBACK)
    - 関数の呼び出し
    - プロシージャの呼び出し (`CALL`)
    - 関数の削除 (`DROP FUNCTION`)
    - プロシージャの削除 (`DROP PROCEDURE`)

---

### ステージ 2: PL/pgSQL の応用とデバッグ

このステージでは、より複雑なシナリオに対応するための機能と、デバッグ方法を学びます。

1.  **カーソル**

    - **明示的カーソル**
      - カーソルの宣言 (`DECLARE cursor_name CURSOR FOR query;`)
      - カーソルのオープン (`OPEN cursor_name;`)
      - カーソルからのフェッチ (`FETCH cursor_name INTO variable;`)
      - カーソルのクローズ (`CLOSE cursor_name;`)
    - **暗黙的カーソル (FOR ループ)**
      - `FOR record_var IN query LOOP ... END LOOP;`

2.  **エラーハンドリング**

    - **例外ブロック (`EXCEPTION`)**
      - `BEGIN ... EXCEPTION WHEN condition THEN ... END;`
      - 定義済み例外条件 (例: `NO_DATA_FOUND`, `TOO_MANY_ROWS`, `DUPLICATE_KEY_VALUE`)
      - カスタム例外 (`RAISE EXCEPTION`)
      - エラー情報の取得 (`SQLSTATE`, `SQLERRM`)
    - **`RAISE` 文**
      - 通知レベル (`NOTICE`, `WARNING`, `EXCEPTION`)
      - エラーメッセージのカスタマイズ
    - トランザクションとエラー処理の連携

3.  **トリガー**

    - **トリガー関数の作成 (`CREATE FUNCTION ... RETURNS TRIGGER`)**
    - **トリガーの作成 (`CREATE TRIGGER`)**
      - イベント (`BEFORE`, `AFTER`, `INSTEAD OF`)
      - 操作 (`INSERT`, `UPDATE`, `DELETE`, `TRUNCATE`)
      - 粒度 (`ROW`, `STATEMENT`)
      - `FOR EACH ROW`, `FOR EACH STATEMENT`
      - `OLD` と `NEW` 変数 (行レベルトリガー)
    - **条件付きトリガー (`WHEN` 句)**
    - トリガーの有効/無効化
    - トリガーの削除

4.  **レコード型と配列**

    - **レコード型**
      - 匿名レコード (`RECORD`)
      - 宣言されたレコード (`variable_name record_type;`)
    - **配列**
      - 配列変数の宣言
      - 配列へのアクセスと操作
      - 配列関数の利用 (例: `array_append`, `array_remove`, `unnest`)

5.  **デバッグとトラブルシューティング**
    - **`RAISE NOTICE` を利用したデバッグ**
    - `pg_log_statements` (postgresql.conf 設定)
    - デバッガーツール (PgAdmin のデバッグ機能など)
    - エラーログの確認方法
    - SQL ステートメントのパフォーマンス分析 (`EXPLAIN ANALYZE`)

---

### ステージ 3: 高度なトピックとベストプラクティス

このステージでは、PL/pgSQL をより効率的かつ堅牢に利用するための高度な概念とベストプラクティスを学びます。

1.  **パフォーマンスの最適化**

    - SQL クエリの最適化 (PL/pgSQL 内部での SELECT, INSERT, UPDATE, DELETE)
    - 動的 SQL (`EXECUTE`) の適切な使用
    - 不要なループやカーソルの回避
    - 一時テーブルの活用
    - 関数の特性 (`IMMUTABLE`, `STABLE`, `VOLATILE`) の理解と適用
    - キャッシュの考慮

2.  **セキュリティ**

    - SQL インジェクション対策 (動的 SQL での `USING` 句の利用)
    - `SECURITY DEFINER` 関数の適切な管理と注意点
    - 権限管理 (`GRANT`, `REVOKE`)

3.  **テストとメンテナンス**

    - PL/pgSQL コードの単体テスト
    - バージョニング管理
    - ドキュメンテーション

4.  **設計パターンとベストプラクティス**
    - モジュール性の維持
    - 可読性の高いコードの記述
    - エラーハンドリングの徹底
    - コメントの活用

---

まずは、下記内容だけに絞って学習教材を作ってください。
例題と解説ごとに、練習問題と解答を出力してください。
注意してほしいのは、例題や練習問題が下記内容で扱うものに留めてくださいということです。後にやる範囲のものを出さないでください。
実行は pgAdmin で行います。

4.  **関数とプロシージャ**
    - **プロシージャの作成 (`CREATE PROCEDURE`)**
      - 引数 (`IN`, `OUT`, `INOUT`)
      - トランザクション制御 (COMMIT, ROLLBACK)
    - 関数の呼び出し
    - プロシージャの呼び出し (`CALL`)
    - 関数の削除 (`DROP FUNCTION`)
    - プロシージャの削除 (`DROP PROCEDURE`)

また、問題は下記テーブルに沿って作成してください。

create table movie (
id bigint generated by default as identity,
created_date timestamp(6) with time zone not null,
modified_date timestamp(6) with time zone not null,
available_globally boolean,
locale varchar(10),
original_title varchar(255),
release_date date,
runtime bigint,
title varchar(255) not null,
primary key (id)
);

comment on column movie.id is
'Primary unique identifier';

comment on column movie.created_date is
'Date when this record was created';

comment on column movie.modified_date is
'Date when this record was last modified';

comment on column movie.available_globally is
'A flag that indicates if this title is available outside US';

comment on column movie.locale is
'The original language/region of the movie';

comment on column movie.original_title is
'The movie title in its original language';

comment on column movie.release_date is
'Date when this title was released';

comment on column movie.runtime is
'The total runtime in minutes';

comment on column movie.title is
'The movie title';

create table season (
id bigint generated by default as identity,
created_date timestamp(6) with time zone not null,
modified_date timestamp(6) with time zone not null,
original_title varchar(255),
release_date date,
runtime bigint,
season_number integer,
title varchar(255) not null,
tv_show_id bigint,
primary key (id)
);

comment on column season.id is
'Primary unique identifier';

comment on column season.created_date is
'Date when this record was created';

comment on column season.modified_date is
'Date when this record was last modified';

comment on column season.original_title is
'The season title in its original language';

comment on column season.release_date is
'Date when this title was released';

comment on column season.runtime is
'The total runtime in minutes';

comment on column season.season_number is
'The season number';

comment on column season.title is
'The season title';

comment on column season.tv_show_id is
'The TV show that this season belongs to';

create table tv_show (
id bigint generated by default as identity,
created_date timestamp(6) with time zone not null,
modified_date timestamp(6) with time zone not null,
available_globally boolean,
locale varchar(10),
original_title varchar(255),
release_date date,
title varchar(255) not null,
primary key (id),
constraint idx_tv_show_title unique (title)
);

comment on column tv_show.id is
'Primary unique identifier';

comment on column tv_show.created_date is
'Date when this record was created';

comment on column tv_show.modified_date is
'Date when this record was last modified';

comment on column tv_show.available_globally is
'A flag that indicates if this title is available outside US';

comment on column tv_show.locale is
'The original language/region of the TV show';

comment on column tv_show.original_title is
'The TV show title in its original language';

comment on column tv_show.release_date is
'Date when this title was released';

comment on column tv_show.title is
'The TV show title';

create table view_summary (
id bigint generated by default as identity,
created_date timestamp(6) with time zone not null,
modified_date timestamp(6) with time zone not null,
cumulative_weeks_in_top10 integer,
duration varchar(20) not null check (duration in ('WEEKLY','SEMI_ANNUALLY')),
end_date date not null,
hours_viewed integer not null,
start_date date not null,
view_rank integer,
views integer,
movie_id bigint,
season_id bigint,
primary key (id)
);

comment on column view_summary.id is
'Primary unique identifier';

comment on column view_summary.created_date is
'Date when this record was created';

comment on column view_summary.modified_date is
'Date when this record was last modified';

comment on column view_summary.cumulative_weeks_in_top10 is
'The number of cumulative weeks in top 10 list';

comment on column view_summary.duration is
'The duration of the period this summary refers to';

comment on column view_summary.end_date is
'The last day of the period this summary refers to';

comment on column view_summary.hours_viewed is
'The total hours viewed during this period';

comment on column view_summary.start_date is
'The first day of the period this summary refers to';

comment on column view_summary.view_rank is
'The rank during this period';

comment on column view_summary.views is
'The number of views during this period';

comment on column view_summary.movie_id is
'The movie for this weekly summary';

comment on column view_summary.season_id is
'The season for this weekly summary';

create index idx_movie_title_runtime 
 on movie (title, runtime);

create index idx_season_title_runtime 
 on season (title, runtime);

create index fk_season_tv_show_id 
 on season (tv_show_id);

alter table if exists season 
 add constraint fk_season_tv_show_id 
 foreign key (tv_show_id) 
 references tv_show;

alter table if exists view_summary 
 add constraint fk_view_summary_movie_id 
 foreign key (movie_id) 
 references movie;

alter table if exists view_summary 
 add constraint fk_view_summary_season_id 
 foreign key (season_id) 
 references season;

tv_show.release_date は null のデータしかないので、使わないでください。
また、created_date と modified_date は一律 20240101 です。

---

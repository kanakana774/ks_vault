### 問題 1：特定の顧客の会員ランクに応じたメッセージ表示

**目的:**

- 基本的なデータ型の変数を宣言し、`SELECT ... INTO` を使って値を取得できる。
- `IF ... ELSIF ... ELSE` を使って条件分岐を行い、異なるメッセージを表示できる。

**問題:**
`CUSTOMER_ID`が`1`の顧客情報を取得し、その顧客の会員ランク（`MEMBERSHIPS`テーブルの`RANK_NAME`）に応じて、以下の通りに異なるメッセージを`RAISE NOTICE`で出力する DO ブロックを作成してください。

- `Gold`の場合: 「ようこそ、プレミアムメンバーの[顧客名]様」
- `Silver`の場合: 「ようこそ、シルバーメンバーの[顧客名]様」
- `Bronze`の場合: 「ようこそ、ブロンズメンバーの[顧客名]様」
- 会員ランクが存在しない場合: 「ようこそ、[顧客名]様」

**解答例:**

```sql
DO $$
DECLARE
    -- 変数の宣言
    v_customer_name VARCHAR;
    v_rank_name VARCHAR;
BEGIN
    -- 顧客名とランク名を取得して変数に格納
    SELECT
        c.NAME,
        m.RANK_NAME
    INTO
        v_customer_name,
        v_rank_name
    FROM
        CUSTOMERS c
    LEFT JOIN
        MEMBERSHIPS m ON c.MEMBERSHIP_ID = m.MEMBERSHIP_ID
    WHERE
        c.CUSTOMER_ID = 1;

    -- 会員ランクに応じてメッセージを分岐
    IF v_rank_name = 'Gold' THEN
        RAISE NOTICE 'ようこそ、プレミアムメンバーの%様', v_customer_name;
    ELSIF v_rank_name = 'Silver' THEN
        RAISE NOTICE 'ようこそ、シルバーメンバーの%様', v_customer_name;
    ELSIF v_rank_name = 'Bronze' THEN
        RAISE NOTICE 'ようこそ、ブロンズメンバーの%様', v_customer_name;
    ELSE
        RAISE NOTICE 'ようこそ、%様', v_customer_name;
    END IF;
END;
$$;
```

---

### 問題 2：全商品の情報をループで表示

**目的:**

- `FOR ... IN ... LOOP` を使ってクエリ結果を 1 行ずつ処理できる。
- `RECORD`型の変数を使って、ループ内の各行のデータにアクセスできる。

**問題:**
`PRODUCTS`テーブルと`CATEGORIES`テーブルを結合し、すべての商品の「商品名」「カテゴリ名」「価格」を取得します。`FOR ... IN ... LOOP` を使用して、取得した結果を 1 行ずつ `RAISE NOTICE`で以下の形式で出力する DO ブロックを作成してください。

**出力形式:**
`商品: [商品名], カテゴリ: [カテゴリ名], 価格: [価格]`

**解答例:**

```sql
DO $$
DECLARE
    -- ループ内でクエリ結果の各行を保持するRECORD型変数を宣言
    r RECORD;
BEGIN
    -- FORループでPRODUCTSとCATEGORIESを結合した結果を反復処理
    FOR r IN
        SELECT
            p.PRODUCT_NAME,
            c.CATEGORY_NAME,
            p.PRICE
        FROM
            PRODUCTS p
        JOIN
            CATEGORIES c ON p.CATEGORY_ID = c.CATEGORY_ID
        ORDER BY
            p.PRODUCT_ID
    LOOP
        -- 各商品の情報をNOTICEとして出力
        RAISE NOTICE '商品: %, カテゴリ: %, 価格: %', r.PRODUCT_NAME, r.CATEGORY_NAME, r.PRICE;
    END LOOP;
END;
$$;
```

---

### 問題 3：在庫状況の確認

**目的:**

- `%ROWTYPE` を使って、テーブルの行構造に合わせた変数を宣言できる。
- `IF`文を使って、数値の範囲に応じた条件分岐ができる。

**問題:**
`PRODUCT_ID`が`1`、`WAREHOUSE_ID`が`1`の在庫情報を`INVENTORY`テーブルから取得します。取得した行データを`INVENTORY%ROWTYPE`型の変数に格納し、その在庫数（`stock_quantity`）に応じて、以下の条件でメッセージを出力する DO ブロックを作成してください。

- 在庫数が 50 以上の場合: 「在庫は十分です (在庫数: [在庫数])」
- 在庫数が 10 以上 50 未満の場合: 「在庫は残りわずかです (在庫数: [在庫数])」
- 在庫数が 1 以上 10 未満の場合: 「在庫が不足しています。発注を検討してください (在庫数: [在庫数])」
- 在庫数が 0 の場合: 「在庫切れです」

**解答例:**

```sql
DO $$
DECLARE
    -- INVENTORYテーブルの行構造と同じ型を持つ変数を宣言
    inventory_row INVENTORY%ROWTYPE;
BEGIN
    -- 特定の商品の在庫情報を取得し、ROWTYPE変数に格納
    SELECT *
    INTO inventory_row
    FROM INVENTORY
    WHERE PRODUCT_ID = 1 AND WAREHOUSE_ID = 1;

    -- 在庫数に応じてメッセージを分岐
    IF inventory_row.stock_quantity >= 50 THEN
        RAISE NOTICE '在庫は十分です (在庫数: %)', inventory_row.stock_quantity;
    ELSIF inventory_row.stock_quantity >= 10 THEN
        RAISE NOTICE '在庫は残りわずかです (在庫数: %)', inventory_row.stock_quantity;
    ELSIF inventory_row.stock_quantity > 0 THEN
        RAISE NOTICE '在庫が不足しています。発注を検討してください (在庫数: %)', inventory_row.stock_quantity;
    ELSE
        RAISE NOTICE '在庫切れです';
    END IF;
END;
$$;
```

---

### 問題 4：整数ループを使ったレビュー評価の集計

**目的:**

- `FOR ... LOOP` を使って、指定した範囲の整数でループ処理ができる。
- ループカウンター変数を利用して、ループごとに異なる処理を行える。

**問題:**
`FOR`ループを使って 1 から 5 までの整数をループ処理します。各ループで、その整数値と同じ評価（`RATING`）が`REVIEWS`テーブルに何件あるかをカウントし、`RAISE NOTICE`で以下の形式で出力する DO ブロックを作成してください。

**出力形式:**
`評価1: [件数]件`
`評価2: [件数]件`
...
`評価5: [件数]件`

**解答例:**

```sql
DO $$
DECLARE
    -- 各評価のレビュー件数を格納する変数を宣言
    review_count INTEGER;
BEGIN
    -- 1から5までループ
    FOR i IN 1..5 LOOP
        -- ループカウンタ変数(i)を使って、各評価の件数を取得
        SELECT
            COUNT(*)
        INTO
            review_count
        FROM
            REVIEWS
        WHERE
            RATING = i;

        -- 結果を出力
        RAISE NOTICE '評価%: %件', i, review_count;
    END LOOP;
END;
$$;
```

---

### 問題 5：顧客ごとの注文合計金額の計算

**目的:**

- 複数のループやクエリを組み合わせて、より複雑な処理を実装できる。
- 異なる型の変数（`RECORD`, `DECIMAL`など）を組み合わせて使用できる。

**問題:**
すべての顧客（`CUSTOMERS`）を対象にループ処理を行います。各顧客について、その顧客が行ったすべての注文（`ORDERS`）の合計金額を計算し、`RAISE NOTICE`で出力してください。合計金額が 0 円の顧客も表示対象とします。

**要件:**

1.  外側のループで`CUSTOMERS`テーブルの全顧客を 1 人ずつ処理します。
2.  内側で、その顧客の注文合計金額を`ORDERITEMS`と`PRODUCTS`テーブルから計算します。
3.  注文ステータスが 'Cancelled' の注文は計算に含めません。
4.  計算した合計金額を、顧客名と共に出力します。

**出力形式:**
`顧客名: [顧客名], 注文合計金額: [合計金額]`

**解答例:**

```sql
DO $$
DECLARE
    -- 顧客情報を保持するRECORD型変数
    customer_rec RECORD;
    -- 注文合計金額を保持する変数
    total_amount DECIMAL;
BEGIN
    -- すべての顧客に対してループ
    FOR customer_rec IN
        SELECT CUSTOMER_ID, NAME FROM CUSTOMERS ORDER BY CUSTOMER_ID
    LOOP
        -- 顧客ごとの注文合計金額を計算
        -- (注文がない場合はNULLになるため、COALESCEで0に変換)
        SELECT
            COALESCE(SUM(oi.QUANTITY * p.PRICE), 0)
        INTO
            total_amount
        FROM
            ORDERS o
        JOIN
            ORDERITEMS oi ON o.ORDER_ID = oi.ORDER_ID
        JOIN
            PRODUCTS p ON oi.PRODUCT_ID = p.PRODUCT_ID
        WHERE
            o.CUSTOMER_ID = customer_rec.CUSTOMER_ID
            AND o.STATUS <> 'Cancelled';

        -- 結果を出力
        RAISE NOTICE '顧客名: %, 注文合計金額: %', customer_rec.NAME, total_amount;
    END LOOP;
END;
$$;
```

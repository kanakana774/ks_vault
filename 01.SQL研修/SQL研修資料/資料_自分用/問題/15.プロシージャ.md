## 問題 1:

引数に customer_id, と新しい membership_id を受け取り、
会員ランクの更新を行うストアドプロシージャを作成してください。
更新が成功したら「顧客 1 の会員ランクを更新しました。」メッセージを返してください。
ただし、メッセージの「顧客 1」の部分は更新する顧客の customer_id を表示するようにしてください。

動作確認として、
customer_id が 1 の顧客を membership_id が 3 になるように
customer_id が 3 の顧客を membership_id が 1 になるように
上記の 2 通りでプロシージャを呼び出して、期待通りの動作になることを確認してください。

## 回答：

```SQL
CREATE OR REPLACE PROCEDURE UPGRADE_MEMBERSHIP (P_CUSTOMER_ID INTEGER, P_NEW_MEMBERSHIP_ID INTEGER) LANGUAGE PLPGSQL AS $$

-- DECLARE
-- DECLAREは省略可能
BEGIN

    -- 顧客情報更新
    UPDATE Customers
    SET membership_id = p_new_membership_id
    WHERE customer_id = p_customer_id;

    RAISE NOTICE '顧客 % の会員ランクを更新しました。', p_customer_id;
END;
$$; -- ；の付け忘れ、つけるべき場所注意

-- 実行例
CALL UPGRADE_MEMBERSHIP (1, 3);

CALL UPGRADE_MEMBERSHIP (3, 1);
```

## 解説：

引数から、Customers テーブルを更新する処理。

## 問題 2：

引数に customer_id, product_id, review_id, rating, comment を受け取り、
以下を行うストアドプロシージャを作成してください。
顧客が商品を購入しているか確認する。
購入履歴がなければ、「商品未購入のため、レビューできません。」というメッセージの例外を発生させる。
購入履歴があれば Reviews に投稿を追加する

動作確認として、
customer_id が 1 である顧客が、product_id が 1 の商品に対して、review_id を 10 として以下のレビュー投稿した場合
レビュー詳細：rating5、「とても素晴らしい商品でした！」とコメント
customer_id が 3 である顧客が、product_id が 1 の商品に対して、review_id を 99 として以下のレビュー投稿した場合
レビュー詳細：rating1、「あまりオススメできません・・・」とコメント
上記の 2 通りでプロシージャを呼び出して、期待通りの動作になることを確認してください。

```SQL
CREATE OR REPLACE PROCEDURE ADD_REVIEW (
	P_CUSTOMER_ID INT, -- intと省略して書くこともできる。
	P_PRODUCT_ID INT,
	P_REVIEW_ID INT,
	P_RATING INT,
	P_COMMENT TEXT
) LANGUAGE PLPGSQL AS $$
DECLARE
    v_cnt INT;
    -- 変数名はvariableのv_を付けることが多い。カラム名を混在しないために。
BEGIN
    -- 購入履歴確認
    SELECT COUNT(*) INTO v_cnt
    FROM Orders o
    JOIN OrderItems oi ON o.order_id = oi.order_id
    WHERE o.customer_id = p_customer_id
      AND oi.product_id = p_product_id;

    IF v_cnt = 0 THEN -- if文
        RAISE EXCEPTION '商品未購入のため、レビューできません。'; -- 例外送出
    END IF;

    -- レビュー追加
    INSERT INTO Reviews (review_id, product_id, customer_id, rating, comment, review_date)
    VALUES (p_review_id, p_product_id, p_customer_id, p_rating, p_comment, CURRENT_DATE);
END;
$$;

-- 実行例
CALL ADD_REVIEW (1, 1, 10, 5, 'とても素晴らしい商品でした！');

CALL ADD_REVIEW (3, 1, 99, 1, 'あまりオススメできません・・・');
```

## 問題 3：

```SQL
-- serialというのは実は型ではなく、下記登録をまとめたシンタックスシュガーなので、alterの型変更では対応できない。下記を実行してもらう。
-- 1. シーケンスを作成
CREATE SEQUENCE orders_order_id_seq;
-- 2. カラムのデフォルト値を設定
ALTER TABLE orders ALTER COLUMN order_id SET DEFAULT nextval('orders_order_id_seq');
-- 3. 必要なら NOT NULL 制約を追加
ALTER TABLE orders ALTER COLUMN order_id SET NOT NULL;
-- 1. シーケンスを作成
CREATE SEQUENCE order_items_order_item_id_seq;
-- 2. カラムのデフォルト値を設定
ALTER TABLE orderitems ALTER COLUMN order_item_id SET DEFAULT nextval('order_items_order_item_id_seq');
-- 3. 必要なら NOT NULL 制約を追加
ALTER TABLE orderitems ALTER COLUMN order_item_id SET NOT NULL;

-- 作成されたsequenceのnextValueを手動で最新のものに更新する（テーブルの最新の値＋１）
```

引数に customer_id, product_id, quantity,order_id を受け取り、
以下を行うストアドプロシージャを作成してください。
warehouse_id=1 の倉庫に対して在庫を確認し、在庫が不足の場合には「在庫不足です」というメッセージの例外を発生させる。
在庫が不足していない場合には、Orders への注文を登録し、その登録した際の order_id で、OrderItems に注文明細を追加する。
さらに、Inventory の在庫数を更新してください（＝注文数を在庫数から差し引く）。

動作確認として、
order_id を 1234 とし、customer_id が 1 である顧客が、product_id が 2 である商品を 10 点購入た場合
order_id を 9999 とし、customer_id が 1 である顧客が、product_id が 2 である商品を 1000 点購入た場合
上記の 2 通りでプロシージャを呼び出して、期待通りの動作になることを確認してください。

```SQL
CREATE OR REPLACE PROCEDURE create_order(
    p_customer_id INT,
    p_product_id INT,
    p_quantity INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_order_id INT;
    v_stock INT;
	v_orderitems_row OrderItems%ROWTYPE;
	v_inventory_row inventory%ROWTYPE;
BEGIN
    -- 在庫確認
    SELECT stock_quantity INTO v_stock
    FROM Inventory
    WHERE product_id = p_product_id AND warehouse_id = 1;

    IF v_stock IS NULL OR v_stock < p_quantity THEN
        RAISE EXCEPTION '在庫不足です。';
    END IF;

    -- 注文作成
    INSERT INTO Orders (customer_id, order_date, status)
    VALUES (p_customer_id, CURRENT_DATE, 'Pending')
    RETURNING order_id INTO v_order_id;

	RAISE NOTICE '%',v_order_id;
    -- 注文明細追加
    INSERT INTO OrderItems (order_id, product_id, quantity)
    VALUES (v_order_id, p_product_id, p_quantity)
	RETURNING * into v_orderitems_row;

	RAISE NOTICE '%',v_orderitems_row;

    -- 在庫更新
    UPDATE Inventory
    SET stock_quantity = stock_quantity - p_quantity
    WHERE product_id = p_product_id
	RETURNING * into v_inventory_row;

	RAISE NOTICE '%',v_inventory_row;
END;
$$;

-- 実行例
CALL create_order(1, 2, 2);


```

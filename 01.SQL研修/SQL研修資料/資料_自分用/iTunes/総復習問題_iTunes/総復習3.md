### 単元 3. 結合/集合演算子/サブクエリ

**問題 1**
`album` テーブルと `artist` テーブルを結合し、すべてのアルバムのタイトルとそれに対応するアーティスト名を取得してください。

**回答**

```sql
SELECT al.title AS album_title, ar.name AS artist_name
FROM album AS al
JOIN artist AS ar
  ON al.artist_id = ar.artist_id;
```

**別パターン (INNER JOIN を明示)**

```sql
SELECT al.title AS album_title, ar.name AS artist_name
FROM album AS al
INNER JOIN artist AS ar
  ON al.artist_id = ar.artist_id;
```

---

**問題 2**
`track` テーブルと `genre` テーブルを結合し、各トラックの名称とジャンル名を取得してください。

**回答**

```sql
SELECT t.name AS track_name, g.name AS genre_name
FROM track AS t
JOIN genre AS g
  ON t.genre_id = g.genre_id;
```

---

**問題 3**
`customer` テーブルと `employee` テーブルを結合し、各顧客の名前 (`first_name`, `last_name`) と、その顧客をサポートしている従業員の名前 (`first_name`, `last_name`) を取得してください。サポート担当者がいない顧客も表示されるようにしてください。

**回答**

```sql
SELECT
    c.first_name AS customer_first_name,
    c.last_name AS customer_last_name,
    e.first_name AS employee_first_name,
    e.last_name AS employee_last_name
FROM customer AS c
LEFT JOIN employee AS e
  ON c.support_rep_id = e.employee_id;
```

---

**問題 4**
`track` テーブルと `media_type` テーブルを結合し、各トラックの名称とメディアタイプの名称を取得してください。

**回答**

```sql
SELECT t.name AS track_name, mt.name AS media_type_name
FROM track AS t
JOIN media_type AS mt
  ON t.media_type_id = mt.media_type_id;
```

---

**問題 5**
`invoice` テーブルと `customer` テーブルを結合し、各請求書の合計金額 (`total`) と、その請求書を支払った顧客の `first_name`, `last_name` を取得してください。

**回答**

```sql
SELECT i.invoice_id, i.total, c.first_name, c.last_name
FROM invoice AS i
JOIN customer AS c
  ON i.customer_id = c.customer_id;
```

---

**問題 6**
`playlist` テーブルと `playlist_track` テーブル、`track` テーブルを結合し、`playlist_id` が `1` のプレイリストに含まれるすべてのトラックの名称を取得してください。

**回答**

```sql
SELECT t.name AS track_name
FROM playlist AS p
JOIN playlist_track AS pt
  ON p.playlist_id = pt.playlist_id
JOIN track AS t
  ON pt.track_id = t.track_id
WHERE p.playlist_id = 1;
```

---

**問題 7**
`employee` テーブルで、上司がいない従業員（`reports_to` が NULL）の `first_name` と `last_name` を取得してください。

**回答**

```sql
SELECT first_name, last_name
FROM employee
WHERE reports_to IS NULL;
```

---

**問題 8**
`customer` テーブルから、`country` が 'Brazil' の顧客の `first_name` と `last_name` を取得し、それと `employee` テーブルから `country` が 'Canada' の従業員の `first_name` と `last_name` を集合演算子を使って表示してください。重複は排除してください。

**回答**

```sql
SELECT first_name, last_name FROM customer WHERE country = 'Brazil'
UNION
SELECT first_name, last_name FROM employee WHERE country = 'Canada';
```

---

**問題 9**
`invoice_line` テーブルを使用して、`unit_price` が `0.99` のトラックが購入された `invoice_id` を、サブクエリを使って取得してください。

**回答**

```sql
SELECT invoice_id
FROM invoice_line
WHERE track_id IN (SELECT track_id FROM track WHERE unit_price = 0.99);
```

⇒これinvice_lineに単価列あるからサブクエリの問題にならないな、、、削除か

---

**問題 10**
`artist` テーブルで、アルバムを全く持たないアーティストの `name` を取得してください。

**回答**

```sql
SELECT ar.name
FROM artist AS ar
LEFT JOIN album AS al
  ON ar.artist_id = al.artist_id
WHERE al.album_id IS NULL;
```

**別パターン (NOT EXISTS を使用)**

```sql
SELECT name
FROM artist AS ar
WHERE NOT EXISTS (SELECT 1 FROM album AS al WHERE al.artist_id = ar.artist_id);
```

**別パターン (NOT IN を使用)**

```sql
SELECT name
FROM artist
WHERE artist_id NOT IN (SELECT DISTINCT artist_id FROM album);
```

---

**問題 11**
`track` テーブルと `invoice_line` テーブルを結合し、一度も購入されたことがないトラックの `name` を取得してください。

**回答**

```sql
SELECT t.name
FROM track AS t
LEFT JOIN invoice_line AS il
  ON t.track_id = il.track_id
WHERE il.invoice_line_id IS NULL;
```

**別パターン (NOT EXISTS を使用)**

```sql
SELECT name
FROM track AS t
WHERE NOT EXISTS (SELECT 1 FROM invoice_line AS il WHERE il.track_id = t.track_id);
```

**別パターン (NOT IN を使用)**

```sql
SELECT name
FROM track
WHERE track_id NOT IN (SELECT DISTINCT track_id FROM invoice_line);
```

---

**問題 12**
`employee` テーブルとそれ自身のテーブルを結合（自己結合）し、各従業員の `first_name`, `last_name` と、その従業員の上司の `first_name`, `last_name` を取得してください。

**回答**

```sql
SELECT
    emp.first_name AS employee_first_name,
    emp.last_name AS employee_last_name,
    mgr.first_name AS manager_first_name,
    mgr.last_name AS manager_last_name
FROM employee AS emp
LEFT JOIN employee AS mgr
  ON emp.reports_to = mgr.employee_id;
```

---

**問題 13**
`customer` テーブルと `invoice` テーブルを結合し、各顧客が支払った請求書の総額を顧客ごとに取得してください。

**回答**

```sql
SELECT
    c.first_name,
    c.last_name,
    SUM(i.total) AS total_spent
FROM customer AS c
JOIN invoice AS i
  ON c.customer_id = i.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name
ORDER BY total_spent DESC;
```

---

**問題 14**
`track` テーブルから、`unit_price` が `0.99` であり、かつ `genre_id` が `1` (Rock) であるトラックの `name` を取得してください。サブクエリを使わずに結合と WHERE 句で実現してください。

**回答**

```sql
SELECT t.name
FROM track AS t
JOIN genre AS g
  ON t.genre_id = g.genre_id
WHERE t.unit_price = 0.99 AND g.name = 'Rock';
```

**別パターン (ジャンル名を直接指定せず、genre_id を使用)**

```sql
SELECT name
FROM track
WHERE unit_price = 0.99 AND genre_id = 1;
```

⇒結合の問題になってない。。。削除かな

**問題 15**
`album` テーブルから、アルバム数が 3 つ以上のアーティストの `name` を取得してください。

**回答**

```sql
SELECT name
FROM artist
WHERE artist_id IN (
    SELECT artist_id
    FROM album
    GROUP BY artist_id
    HAVING COUNT(album_id) >= 3
);
```

---

**問題 16**
`customer` テーブルから、一度も請求書を発行していない顧客の `first_name` と `last_name` を取得してください。

**回答**

```sql
SELECT first_name, last_name
FROM customer
WHERE customer_id NOT IN (
    SELECT DISTINCT customer_id
    FROM invoice
);
```

**別パターン (NOT EXISTS を使用)**

```sql
SELECT c.first_name, c.last_name
FROM customer AS c
WHERE NOT EXISTS (
    SELECT 1
    FROM invoice AS i
    WHERE i.customer_id = c.customer_id
);
```

---

**問題 17**
`track` テーブルから、そのトラックが属するジャンルの平均 `unit_price` よりも価格が高いトラックの `name` と `unit_price` を取得してください。

**回答**

```sql
SELECT t1.name, t1.unit_price
FROM track AS t1
WHERE t1.unit_price > (
    SELECT AVG(t2.unit_price)
    FROM track AS t2
    WHERE t2.genre_id = t1.genre_id
);
```

---

**問題 18**
`invoice` テーブルから、2021 年 1 月の平均 `total` よりも合計金額が高い請求書の `invoice_id` と `total` を取得してください。

**回答**

```sql
SELECT invoice_id, total
FROM invoice
WHERE total > (
    SELECT AVG(total)
    FROM invoice
    WHERE invoice_date >= '2021-01-01' AND invoice_date < '2021-02-01'
);
```

---

**問題 19**
`customer` テーブルから、最も多くの請求書を持つ顧客の `first_name` と `last_name` を取得してください。

**回答**

```sql
SELECT first_name, last_name
FROM customer
WHERE customer_id = (
    SELECT customer_id
    FROM invoice
    GROUP BY customer_id
    ORDER BY COUNT(invoice_id) DESC
    LIMIT 1
);
```

**別パターン (WITH 句 (CTE) を使用)**

```sql
WITH CustomerInvoiceCounts AS (
    SELECT
        customer_id,
        COUNT(invoice_id) AS invoice_count
    FROM invoice
    GROUP BY customer_id
    ORDER BY invoice_count DESC
    LIMIT 1
)
SELECT c.first_name, c.last_name
FROM customer AS c
JOIN CustomerInvoiceCounts AS cic
  ON c.customer_id = cic.customer_id;
```

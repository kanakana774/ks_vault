### PL/pgSQL の基本的な構文と制御構造

PL/pgSQL は PostgreSQL で使用される手続き型言語です。SQL の能力を拡張し、複雑なロジックや条件分岐、ループ処理などをデータベース内で実行できるようにします。

#### 2.1. PL/pgSQL の基本的な構造 (DO ブロック)

PL/pgSQL コードは、`DO` ブロック内で直接実行できます。これは、ストアドプロシージャやファンクションを作成する前に、PL/pgSQL のコードをテストするのに非常に便利です。

```sql
DO $$
BEGIN
    -- ここにPL/pgSQLのコードを記述
    RAISE NOTICE 'Hello, PL/pgSQL!';
END
$$;
```

上記の例では、`RAISE NOTICE` コマンドを使ってメッセージをクライアントに出力しています。

#### 2.2. ブロック構造

PL/pgSQL コードは、論理的なブロック構造を持っています。

##### DECLARE セクション

`DECLARE` セクションは、ブロック内で使用する変数を宣言するために使用されます。このセクションは `BEGIN` キーワードの前に配置されます。

##### BEGIN ... END ブロック

`BEGIN ... END` ブロックは、実際の実行可能な PL/pgSQL ステートメントを含むセクションです。すべてのロジックはここに含まれます。

##### ラベル (オプション)

ブロックにラベルを付けることで、コードの可読性を向上させたり、ネストされたブロックで特定のブロックを参照したりすることができます。ラベルは `<<label_name>>` の形式で定義し、`END label_name;` で閉じます。

**例:**

```sql
DO $$
<<my_first_block>>
DECLARE
    message TEXT := 'Welcome to PL/pgSQL!';
BEGIN
    RAISE NOTICE '%', message;
END my_first_block $$;
```

#### 2.3. 変数

PL/pgSQL では、さまざまな目的で変数を宣言し、使用することができます。

##### 変数の宣言 (`DECLARE variable_name data_type [DEFAULT value];`)

変数を宣言する際には、変数名、データ型、そしてオプションで初期値を指定します。

**例:**

```sql
DO $$
DECLARE
    counter INTEGER;          -- 整数型の変数
    user_name TEXT DEFAULT 'Guest'; -- テキスト型の変数に初期値を設定
    is_active BOOLEAN := TRUE; -- 真偽値型の変数に初期値を設定 (:= でも代入可能)
BEGIN
    counter := 10; -- 変数に値を代入
    RAISE NOTICE 'Counter: %, User: %, Active: %', counter, user_name, is_active;
END
$$;
```

##### データ型 (INTEGER, TEXT, BOOLEAN, DATE など)

PostgreSQL の組み込みデータ型は、PL/pgSQL の変数宣言でほとんどそのまま使用できます。一般的なデータ型には以下のようなものがあります。

- `INTEGER`: 整数
- `TEXT` または `VARCHAR`: 文字列
- `NUMERIC` または `DECIMAL`: 精度を指定できる数値
- `BOOLEAN`: 真偽値 (TRUE/FALSE)
- `DATE`, `TIMESTAMP`: 日付と時刻

##### `%TYPE` (テーブル列のデータ型を参照)

`%TYPE` 属性を使用すると、既存のテーブルの列と同じデータ型を持つ変数を宣言できます。これにより、テーブルのスキーマ変更があった場合でも、PL/pgSQL コードの変更を最小限に抑えることができます。

**例:** `customer` テーブルの `first_name` 列のデータ型と同じ型の変数を宣言します。

```sql
DO $$
DECLARE
    customer_fname customer.first_name%TYPE; -- customerテーブルのfirst_name列と同じ型
BEGIN
    -- 顧客ID 1 の顧客名を取得し、変数に代入
    SELECT first_name INTO customer_fname FROM customer WHERE customer_id = 1;
    RAISE NOTICE 'Customer First Name: %', customer_fname;
END
$$;
```

##### `%ROWTYPE` (テーブル行全体のデータ型を参照)

`%ROWTYPE` 属性を使用すると、既存のテーブルの行全体を表す複合型の変数を宣言できます。この変数には、テーブルのすべての列がフィールドとして含まれます。

**例:** `customer` テーブルの行全体を保持する変数を宣言します。

```sql
DO $$
DECLARE
    customer_record customer%ROWTYPE; -- customerテーブルの行全体の型
BEGIN
    -- 顧客ID 1 の顧客レコードを取得
    SELECT * INTO customer_record FROM customer WHERE customer_id = 1;

    -- レコードのフィールドにアクセス
    RAISE NOTICE 'Customer ID: %', customer_record.customer_id;
    RAISE NOTICE 'Customer Name: % %', customer_record.first_name, customer_record.last_name;
    RAISE NOTICE 'Customer Email: %', customer_record.email;
END
$$;
```

##### 変数の代入 (`variable := expression;`)

変数は `:=` 演算子を使用して値を代入できます。`SELECT INTO` ステートメントを使用しても、クエリ結果を変数に代入できます。

**例:**

```sql
DO $$
DECLARE
    a INTEGER := 5;
    b INTEGER := 10;
    sum_val INTEGER;
    artist_name artist.name%TYPE;
BEGIN
    sum_val := a + b; -- 式の結果を代入
    RAISE NOTICE 'Sum: %', sum_val;

    -- SELECT INTO を使用してクエリ結果を代入
    SELECT name INTO artist_name FROM artist WHERE artist_id = 1;
    RAISE NOTICE 'Artist Name: %', artist_name;
END
$$;
```

---

### 練習問題

以下の指示に従って PL/pgSQL の `DO` ブロックを作成してください。

#### 問題 1: 基本的な変数宣言と代入

1.  `DO` ブロック内で、`employee_id_val` という名前の `INTEGER` 型の変数を宣言し、初期値として `3` を代入してください。
2.  `employee_name_val` という名前の `TEXT` 型の変数を宣言し、初期値として `'Jane Doe'` を代入してください。
3.  `hire_date_val` という名前の `DATE` 型の変数を宣言し、`'2020-01-15'` を代入してください。
4.  これらの変数の値を `RAISE NOTICE` で出力してください。

#### 問題 2: `%TYPE` の使用

1.  `DO` ブロック内で、`customer_email_address` という名前の変数を、`customer` テーブルの `email` 列と同じデータ型 (`%TYPE`) で宣言してください。
2.  `customer_id` を `10` と指定し、その顧客の `email` アドレスを `customer_email_address` 変数に代入してください。
3.  `RAISE NOTICE` で `customer_email_address` の値を出力してください。

#### 問題 3: `%ROWTYPE` の使用

1.  `DO` ブロック内で、`album_info` という名前の変数を、`album` テーブルの行全体と同じデータ型 (`%ROWTYPE`) で宣言してください。
2.  `album_id` が `5` のアルバムの情報を取得し、`album_info` 変数に代入してください。
3.  `RAISE NOTICE` を使用して、`album_info.title` と `album_info.artist_id` の値を出力してください。

#### 問題 4: ブロックラベルと複数の変数代入

1.  `DO` ブロックに `album_artist_block` というラベルを付けてください。
2.  `album_title_var` 変数を `album.title%TYPE` で宣言してください。
3.  `artist_name_var` 変数を `artist.name%TYPE` で宣言してください。
4.  `album_id` が `12` のアルバムのタイトルを `album_title_var` に代入してください。
5.  同じアルバム (ID `12`) の `artist_id` を使用して、そのアーティストの名前を `artist_name_var` に代入してください。
    - ヒント: まずアルバムから `artist_id` を取得し、その `artist_id` を使って `artist` テーブルから名前を取得します。一時的な `artist_id_temp` 変数を使用しても構いません。
6.  `RAISE NOTICE` でアルバムタイトルとアーティスト名の両方を出力してください。

---

### 解答

#### 問題 1: 基本的な変数宣言と代入

```sql
DO $$
DECLARE
    employee_id_val INTEGER := 3;
    employee_name_val TEXT := 'Jane Doe';
    hire_date_val DATE := '2020-01-15';
BEGIN
    RAISE NOTICE 'Employee ID: %', employee_id_val;
    RAISE NOTICE 'Employee Name: %', employee_name_val;
    RAISE NOTICE 'Hire Date: %', hire_date_val;
END
$$;
```

#### 問題 2: `%TYPE` の使用

```sql
DO $$
DECLARE
    customer_email_address customer.email%TYPE;
    target_customer_id INTEGER := 10;
BEGIN
    SELECT email INTO customer_email_address
    FROM customer
    WHERE customer_id = target_customer_id;

    RAISE NOTICE 'Customer Email for ID %: %', target_customer_id, customer_email_address;
END
$$;
```

#### 問題 3: `%ROWTYPE` の使用

```sql
DO $$
DECLARE
    album_info album%ROWTYPE;
    target_album_id INTEGER := 5;
BEGIN
    SELECT * INTO album_info
    FROM album
    WHERE album_id = target_album_id;

    RAISE NOTICE 'Album Title for ID %: %', target_album_id, album_info.title;
    RAISE NOTICE 'Artist ID for Album ID %: %', target_album_id, album_info.artist_id;
END
$$;
```

#### 問題 4: ブロックラベルと複数の変数代入

```sql
DO $$
<<album_artist_block>>
DECLARE
    album_title_var album.title%TYPE;
    artist_name_var artist.name%TYPE;
    album_artist_id_temp album.artist_id%TYPE; -- 一時的にartist_idを格納する変数
    target_album_id INTEGER := 12;
BEGIN
    -- アルバムのタイトルとアーティストIDを取得
    SELECT title, artist_id
    INTO album_title_var, album_artist_id_temp
    FROM album
    WHERE album_id = target_album_id;

    -- 取得したアーティストIDを使ってアーティスト名を取得
    SELECT name
    INTO artist_name_var
    FROM artist
    WHERE artist_id = album_artist_id_temp;

    RAISE NOTICE 'Album ID %: Title = %, Artist = %', target_album_id, album_title_var, artist_name_var;
END album_artist_block $$;
```

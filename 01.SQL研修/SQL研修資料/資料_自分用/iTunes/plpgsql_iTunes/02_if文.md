### PL/pgSQL の基本的な構文と制御構造 (続き)

#### 2.4. 条件分岐

PL/pgSQL では、プログラムの実行フローを特定の条件に基づいて変更するために条件分岐を使用します。

##### `IF ... THEN ... END IF;`

最も基本的な条件分岐です。指定された条件が真 (`TRUE`) の場合にのみ、`THEN` と `END IF` の間のステートメントが実行されます。

**構文:**

```sql
IF condition THEN
    statements;
END IF;
```

**例:** `track` の単価が `1.00` より大きい場合にメッセージを出力します。

```sql
DO $$
DECLARE
    track_price track.unit_price%TYPE := 1.29;
BEGIN
    IF track_price > 1.00 THEN
        RAISE NOTICE 'このトラックは高価です。';
    END IF;
END
$$;
```

##### `IF ... THEN ... ELSE ... END IF;`

条件が真 (`TRUE`) の場合と偽 (`FALSE`) の場合で、異なるステートメントを実行したいときに使用します。

**構文:**

```sql
IF condition THEN
    statements_for_true;
ELSE
    statements_for_false;
END IF;
```

**例:** `customer` の国が `USA` かどうかで異なるメッセージを出力します。

```sql
DO $$
DECLARE
    customer_country customer.country%TYPE := 'USA';
BEGIN
    IF customer_country = 'USA' THEN
        RAISE NOTICE '顧客はアメリカ国内にいます。';
    ELSE
        RAISE NOTICE '顧客はアメリカ国外にいます。';
    END IF;
END
$$;
```

##### `IF ... THEN ... ELSIF ... ELSE ... END IF;`

複数の条件を順に評価し、最初に真になった条件に対応するステートメントを実行します。どの条件も真にならなかった場合は、オプションの `ELSE` ブロックが実行されます。

**構文:**

```sql
IF condition_1 THEN
    statements_for_condition_1;
ELSIF condition_2 THEN
    statements_for_condition_2;
ELSIF condition_N THEN
    statements_for_condition_N;
ELSE
    statements_for_else; -- すべての条件が偽の場合
END IF;
```

**例:** `employee` の役職に基づいて異なるメッセージを出力します。

```sql
DO $$
DECLARE
    employee_title employee.title%TYPE := 'Sales Support Agent';
BEGIN
    IF employee_title = 'General Manager' THEN
        RAISE NOTICE '役職: ジェネラルマネージャー';
    ELSIF employee_title = 'IT Manager' THEN
        RAISE NOTICE '役職: ITマネージャー';
    ELSIF employee_title LIKE 'Sales%' THEN -- 'Sales'で始まる役職
        RAISE NOTICE '役職: 営業職';
    ELSE
        RAISE NOTICE '役職: その他';
    END IF;
END
$$;
```

##### `CASE` 文 (単純な CASE, 検索 CASE)

`CASE` 文は、複数の条件分岐をより簡潔に記述するための構造です。2 つの形式があります。

###### 単純な `CASE`

式の結果が特定の値と一致するかどうかを比較します。

**構文:**

```sql
CASE expression
    WHEN value_1 THEN
        statements_for_value_1;
    WHEN value_2 THEN
        statements_for_value_2;
    ...
    ELSE
        statements_for_else; -- どの値にも一致しない場合
END CASE;
```

**例:** `genre_id` に基づいてジャンル名を出力します。

```sql
DO $$
DECLARE
    genre_id_val genre.genre_id%TYPE := 1; -- 1: Rock
    genre_name_text TEXT;
BEGIN
    CASE genre_id_val
        WHEN 1 THEN
            genre_name_text := 'Rock';
        WHEN 2 THEN
            genre_name_text := 'Jazz';
        WHEN 3 THEN
            genre_name_text := 'Metal';
        ELSE
            genre_name_text := 'Unknown Genre';
    END CASE;
    RAISE NOTICE 'Genre ID % corresponds to: %', genre_id_val, genre_name_text;
END
$$;
```

###### 検索 `CASE`

各 `WHEN` 句に異なる条件式を指定できます。`IF ... ELSIF ... ELSE` に似ていますが、より構造化されています。

**構文:**

```sql
CASE
    WHEN condition_1 THEN
        statements_for_condition_1;
    WHEN condition_2 THEN
        statements_for_condition_2;
    ...
    ELSE
        statements_for_else; -- どの条件も真にならない場合
END CASE;
```

**例:** `track` のミリ秒数に基づいて曲の長さを分類します。

```sql
DO $$
DECLARE
    track_milliseconds track.milliseconds%TYPE := 250000; -- 約4分10秒
    track_length_category TEXT;
BEGIN
    CASE
        WHEN track_milliseconds < 180000 THEN -- 3分未満
            track_length_category := 'Short';
        WHEN track_milliseconds >= 180000 AND track_milliseconds < 300000 THEN -- 3分以上5分未満
            track_length_category := 'Medium';
        ELSE -- 5分以上
            track_length_category := 'Long';
    END CASE;
    RAISE NOTICE 'Track Length (%ms): %', track_milliseconds, track_length_category;
END
$$;
```

---

### 練習問題

以下の指示に従って PL/pgSQL の `DO` ブロックを作成してください。

#### 問題 1: `IF ... THEN ... END IF;` の使用

1.  `DO` ブロック内で、`invoice_total_amount` という名前の `NUMERIC(10,2)` 型の変数を宣言し、初期値として `15.99` を代入してください。
2.  もし `invoice_total_amount` が `10.00` より大きい場合、`RAISE NOTICE` で `'合計金額は10ドルを超えています。'` と出力してください。

#### 問題 2: `IF ... THEN ... ELSE ... END IF;` の使用

1.  `DO` ブロック内で、`customer_country_val` という名前の `customer.country%TYPE` 型の変数を宣言し、初期値として `'Germany'` を代入してください。
2.  もし `customer_country_val` が `'USA'` と等しい場合、`RAISE NOTICE` で `'アメリカの顧客です。'` と出力してください。
3.  そうでなければ、`RAISE NOTICE` で `'アメリカ以外の顧客です。'` と出力してください。

#### 問題 3: `IF ... THEN ... ELSIF ... ELSE ... END IF;` の使用

1.  `DO` ブロック内で、`employee_id_val` という名前の `INTEGER` 型の変数を宣言し、初期値として `3` を代入してください。
2.  `employee_title_val` という名前の `employee.title%TYPE` 型の変数を宣言してください。
3.  `employee_id_val` に対応する従業員の `title` を `employee_title_val` に代入してください。
4.  `employee_title_val` の値に基づいて、以下のようにメッセージを出力してください。
    - `'Sales Support Agent'` の場合: `'営業サポート担当者です。'`
    - `'IT Staff'` の場合: `'ITスタッフです。'`
    - 上記以外の場合: `'その他の役職です。'`

#### 問題 4: 単純な `CASE` 文の使用

1.  `DO` ブロック内で、`media_type_id_val` という名前の `INTEGER` 型の変数を宣言し、初期値として `1` を代入してください。
2.  `media_type_name_val` という名前の `media_type.name%TYPE` 型の変数を宣言してください。
3.  `media_type_id_val` の値に基づいて、`media_type_name_val` に適切なメディアタイプ名を代入し、`RAISE NOTICE` で出力してください。
    - `1` の場合: `'MPEG audio file'`
    - `2` の場合: `'Protected AAC audio file'`
    - `3` の場合: `'Purchased AAC audio file'`
    - 上記以外の場合: `'Unknown media type'`

#### 問題 5: 検索 `CASE` 文の使用

1.  `DO` ブロック内で、`customer_id_val` という名前の `INTEGER` 型の変数を宣言し、初期値として `20` を代入してください。
2.  `customer_city_val` という名前の `customer.city%TYPE` 型の変数を宣言し、`customer_id_val` に対応する顧客の `city` を代入してください。
3.  `customer_city_val` の値に基づいて、以下のように顧客のエリアを分類し、`RAISE NOTICE` で出力してください。
    - `'London'` または `'Paris'` の場合: `'ヨーロッパの大都市'`
    - `'New York'` または `'Los Angeles'` の場合: `'アメリカの大都市'`
    - 上記以外の場合: `'その他の都市'`

---

### 解答

#### 問題 1: `IF ... THEN ... END IF;` の使用

```sql
DO $$
DECLARE
    invoice_total_amount NUMERIC(10,2) := 15.99;
BEGIN
    IF invoice_total_amount > 10.00 THEN
        RAISE NOTICE '合計金額は10ドルを超えています。';
    END IF;
END
$$;
```

#### 問題 2: `IF ... THEN ... ELSE ... END IF;` の使用

```sql
DO $$
DECLARE
    customer_country_val customer.country%TYPE := 'Germany';
BEGIN
    IF customer_country_val = 'USA' THEN
        RAISE NOTICE 'アメリカの顧客です。';
    ELSE
        RAISE NOTICE 'アメリカ以外の顧客です。';
    END IF;
END
$$;
```

#### 問題 3: `IF ... THEN ... ELSIF ... ELSE ... END IF;` の使用

```sql
DO $$
DECLARE
    employee_id_val INTEGER := 3;
    employee_title_val employee.title%TYPE;
BEGIN
    -- 従業員IDに対応する役職を取得
    SELECT title INTO employee_title_val
    FROM employee
    WHERE employee_id = employee_id_val;

    IF employee_title_val = 'Sales Support Agent' THEN
        RAISE NOTICE '営業サポート担当者です。';
    ELSIF employee_title_val = 'IT Staff' THEN
        RAISE NOTICE 'ITスタッフです。';
    ELSE
        RAISE NOTICE 'その他の役職です。';
    END IF;
END
$$;
```

#### 問題 4: 単純な `CASE` 文の使用

```sql
DO $$
DECLARE
    media_type_id_val INTEGER := 1;
    media_type_name_val media_type.name%TYPE;
BEGIN
    CASE media_type_id_val
        WHEN 1 THEN
            media_type_name_val := 'MPEG audio file';
        WHEN 2 THEN
            media_type_name_val := 'Protected AAC audio file';
        WHEN 3 THEN
            media_type_name_val := 'Purchased AAC audio file';
        ELSE
            media_type_name_val := 'Unknown media type';
    END CASE;
    RAISE NOTICE 'Media Type ID % is: %', media_type_id_val, media_type_name_val;
END
$$;
```

#### 問題 5: 検索 `CASE` 文の使用

```sql
DO $$
DECLARE
    customer_id_val INTEGER := 20; -- 例えば、顧客ID 20 は London の顧客です
    customer_city_val customer.city%TYPE;
    customer_area_category TEXT;
BEGIN
    -- 顧客IDに対応する都市名を取得
    SELECT city INTO customer_city_val
    FROM customer
    WHERE customer_id = customer_id_val;

    CASE
        WHEN customer_city_val IN ('London', 'Paris') THEN
            customer_area_category := 'ヨーロッパの大都市';
        WHEN customer_city_val IN ('New York', 'Los Angeles') THEN
            customer_area_category := 'アメリカの大都市';
        ELSE
            customer_area_category := 'その他の都市';
    END CASE;
    RAISE NOTICE 'Customer ID % (City: %) is categorized as: %', customer_id_val, customer_city_val, customer_area_category;
END
$$;
```

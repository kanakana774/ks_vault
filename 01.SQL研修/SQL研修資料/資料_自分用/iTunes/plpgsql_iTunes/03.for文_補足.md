PL/pgSQL におけるループ処理にはいくつかの方法があり、それぞれに適した利用場面があります。実務では、特に**クエリ結果を一行ずつ処理する `FOR ... IN ... LOOP`** が頻繁に使用されます。

以下に、実務でよく使われる代表的なループ文をそれぞれの特徴と使用例とともに紹介します。

### 1. FOR ... IN ... LOOP (クエリ結果のループ)

**実務で最もよく使われるループです。** `SELECT`文の結果セットを 1 行ずつ順番に処理したい場合に非常に便利です。カーソルを明示的に宣言することなく、簡潔に記述できます。

**どのような時に使うか？**

- テーブルの各行に対して、何らかの更新や計算処理を行いたい場合
- 複数のテーブルを結合した結果を基に、複雑な処理を行いたい場合

**構文:**

```sql
FOR target IN query LOOP
    statements
END LOOP;
```

**実用的な例：**
`employees` テーブルの各従業員の給与を 5%昇給させるプロシージャ

```sql
DO $$
DECLARE
    employee_record RECORD;
BEGIN
    FOR employee_record IN SELECT * FROM employees LOOP
        -- 各従業員の給与を更新
        UPDATE employees
        SET salary = salary * 1.05
        WHERE employee_id = employee_record.employee_id;

        RAISE NOTICE 'Updated salary for employee: %', employee_record.employee_name;
    END LOOP;
END;
$$;
```

この例では、`employees`テーブルの全レコードを 1 行ずつ`employee_record`という変数に格納し、ループ内でそのレコードの給与を更新しています。

---

### 2. FOR ... LOOP (整数ループ)

決まった回数だけ処理を繰り返したい場合に使用します。単純な繰り返し処理に適しています。

**どのような時に使うか？**

- 指定した回数だけテストデータを挿入したい場合
- 月ごと（1 月から 12 月まで）の集計処理を行いたい場合

**構文:**

```sql
FOR loop_counter IN [ REVERSE ] from..to [ BY step ] LOOP
    statements
END LOOP;
```

**実用的な例：**
1 月から 12 月までの月別データを集計テーブルに挿入する

```sql
DO $$
BEGIN
    FOR i IN 1..12 LOOP
        -- 各月の売上サマリを計算して挿入する（salesテーブルは別途存在すると仮定）
        INSERT INTO monthly_summary (month, total_sales)
        SELECT i, SUM(amount)
        FROM sales
        WHERE EXTRACT(MONTH FROM sales_date) = i;
    END LOOP;
END;
$$;
```

この例では、カウンタ変数 `i` が 1 から 12 まで 1 ずつ増えながら、12 回ループ処理が実行されます。 `REVERSE` を使うと逆順に、`BY` を使うとステップ数を指定できます。

---

### 3. WHILE ... LOOP

特定の条件が満たされている間、処理を繰り返したい場合に使用します。 ループの前に条件を評価するため、一度も実行されない可能性があります。

**どのような時に使うか？**

- 特定の状態（例：キューにデータが残っているなど）が解消されるまで処理を続けたい場合
- ループの継続条件が、ループ内の処理によって変化する場合

**構文:**

```sql
WHILE condition LOOP
statements
END LOOP;

```

**実用的な例：**
在庫が 100 個未満になるまで、製品を発注し続ける

```sql
DO $$
DECLARE
    current_stock INT;
BEGIN
    SELECT stock_quantity INTO current_stock FROM products WHERE product_id = 1;

    WHILE current_stock < 100 LOOP
        -- 発注処理（ここでは単純に在庫を10増やす）
        UPDATE products
        SET stock_quantity = stock_quantity + 10
        WHERE product_id = 1
        RETURNING stock_quantity INTO current_stock;

        RAISE NOTICE 'Ordered. Current stock: %', current_stock;
    END LOOP;
END;
$$;
```

---

### 4. FOREACH ... IN ARRAY ... LOOP

配列の各要素に対して処理を行いたい場合に使用します。

**どのような時に使うか？**

- 引数で受け取った ID の配列を使って、一括でステータスを更新したい場合
- 複数の設定値を配列で管理し、それぞれに対して処理を行いたい場合

**構文:**

```sql
FOREACH target IN ARRAY expression LOOP
    statements
END LOOP;
```

**実用的な例：**
指定された複数の製品 ID の価格を更新する

```sql
DO $$
DECLARE
    product_ids INT[] := ARRAY[101, 105, 120];
    pid INT;
BEGIN
    FOREACH pid IN ARRAY product_ids LOOP
        -- 価格を10%引きにする
        UPDATE products
        SET price = price * 0.9
        WHERE product_id = pid;
    END LOOP;
END;
$$;
```

この例では、`product_ids` 配列の各要素が変数 `pid` に順番に代入され、ループが実行されます。

### まとめ

PL/pgSQL には複数のループ構文がありますが、実務では以下の使い分けが一般的です。

| ループの種類            | よく使われる場面                                                         |
| :---------------------- | :----------------------------------------------------------------------- |
| **FOR ... IN ... LOOP** | **クエリ結果（テーブルの行など）に対する繰り返し処理（最も頻繁に利用）** |
| **FOR ... LOOP**        | 決まった回数の繰り返し                                                   |
| **WHILE ... LOOP**      | 特定の条件が満たされるまでの繰り返し                                     |
| **FOREACH ... LOOP**    | 配列要素に対する繰り返し                                                 |

これらのループを適切に使い分けることで、効率的で可読性の高い PL/pgSQL のコードを記述することができます。

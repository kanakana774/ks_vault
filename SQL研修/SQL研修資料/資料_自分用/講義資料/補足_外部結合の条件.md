# **SQL LEFT JOIN における ON 句と WHERE 句の違い**

SQL の LEFT JOIN を使用する際、条件を ON 句と WHERE 句のどちらに書くかによって、クエリの結果は大きく変わります。この違いは、それぞれの句が**評価されるタイミング**に起因します。

### **基本概念**

- **ON 句**
  - **評価タイミング**: 結合処理の最中
  - **役割**: どのレコードとどのレコードを結合するか、**結合条件**を定義します。
  - **LEFT JOIN の特性**: ON 句の条件を満たさなくても、左側のテーブルのレコードは常に結果に保持されます。
- **WHERE 句**
  - **評価タイミング**: 結合処理が完了した後
  - **役割**: 結合された結果全体を、さらに**絞り込む**ための条件を定義します。
  - **LEFT JOIN の特性**: WHERE 句の条件を満たさないレコードは、**最終結果から完全に除外されます**。

### **シナリオ 1: 右側テーブルの条件で絞り込む**

**テーブル構成:**

- **customer (左側テーブル)**

  | id  | name   |
  | :-- | :----- |
  | 1   | A さん |
  | 2   | B さん |
  | 3   | C さん |

- **order (右側テーブル)**

  | id  | customer_id | date       | status    |
  | :-- | :---------- | :--------- | :-------- |
  | 101 | 1           | 2023-01-10 | completed |
  | 102 | 1           | 2023-02-15 | pending   |
  | 103 | 2           | 2023-03-20 | completed |

**目標**: 「完了済み(status \= 'completed')の注文を持つ顧客」と、「注文のない顧客」を一覧で表示したい。

#### **① ON 句に条件を書く**

```SQL
SELECT
 c.name,
 o.id AS order_id,
 o.status
FROM
 customer AS c
LEFT JOIN
 "order" AS o
ON
 c.id = o.customer_id AND o.status = 'completed';
```

**解説**: LEFT JOIN の特性により、customer テーブルの全レコードは保持されます。ON 句の条件を満たした order レコードのみが結合され、満たさない場合は NULL となります。

結果:  
| name | order_id | status |  
| :--- | :--- | :--- |  
| A さん | 101 | completed |  
| B さん | 103 | completed |  
| C さん | NULL | NULL |

#### **② WHERE 句に条件を書く**

```SQL
SELECT
 c.name,
 o.id AS order_id,
 o.status
FROM
 customer AS c
LEFT JOIN
 "order" AS o
ON
 c.id = o.customer_id
WHERE
 o.status = 'completed';
```

**解説**: LEFT JOIN で結合された後、WHERE 句が評価されます。このとき、o.status が NULL であるレコード（C さん）は条件を満たさないため、結果から**除外されます**。

結果:  
| name | order_id | status |  
| :--- | :--- | :--- |  
| A さん | 101 | completed |  
| B さん | 103 | completed |

### **シナリオ 2: 左側テーブルの条件で絞り込む**

**目標**: 「ID が 1 より大きい顧客」と、その注文情報を一覧で表示したい。

#### **① ON 句に条件を書く**

```SQL
SELECT
 c.name,
 o.id AS order_id,
 o.status
FROM
 customer AS c
LEFT JOIN
 "order" AS o
ON
 c.id = o.customer_id AND c.id > 1;
```

**解説**: ON 句の条件に c.id \> 1 が追加されます。c.id \= 1 の A さんはこの条件を満たさないため、order テーブルとの結合は行われません。しかし、LEFT JOIN の特性により、A さんのレコードは残されます。

結果:  
| name | order_id | status |  
| :--- | :--- | :--- |  
| A さん | NULL | NULL |  
| B さん | 103 | completed |  
| C さん | NULL | NULL |

#### **② WHERE 句に条件を書く**

```SQL
SELECT
 c.name,
 o.id AS order_id,
 o.status
FROM
 customer AS c
LEFT JOIN
 "order" AS o
ON
 c.id = o.customer_id
WHERE
 c.id > 1;
```

**解説**: LEFT JOIN が完了した後、WHERE 句が評価されます。c.id \= 1 の A さんのレコードは、この段階で**最終結果から除外されます**。

結果:  
| name | order_id | status |  
| :--- | :--- | :--- |  
| B さん | 103 | completed |  
| C さん | NULL | NULL |

### **まとめ**

|              | 右側テーブルへの条件                                                                                   | 左側テーブルへの条件                                                                               |
| :----------- | :----------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------- |
| **ON 句**    | **結合されるレコードを絞り込む**\<br\>→ LEFT JOIN の特性を維持したまま、右側をフィルタリングできる。   | **左側レコードは残る**\<br\>→ NULL が返されるだけで、意図したフィルタリングにはならない。          |
| **WHERE 句** | **最終結果からレコードを除外する**\<br\>→ LEFT JOIN の特性が失われ、実質的に INNER JOIN と同じになる。 | **最終結果からレコードを除外する**\<br\>→ 意図した通りの絞り込みができるため、これが正しい使い方。 |

ON 句はあくまで**結合ルール**であり、WHERE 句は**最終的な結果の選別**と考えると、それぞれの使い分けが明確になります。

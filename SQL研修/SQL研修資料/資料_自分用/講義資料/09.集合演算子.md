## **集合演算 (Set Operations)**

集合演算は、複数の SELECT 文の結果を垂直に結合するために使用されます。各 SELECT 文の列の数とデータ型が一致している必要があります。

### **UNION：和集合（重複排除）**

複数の SELECT 文の結果を結合し、**重複する行を排除**して返します。

#### **基本構文**

```SQL
SELECT 列リスト FROM テーブル 1
UNION
SELECT 列リスト FROM テーブル 2;
```

#### **例: 商品名とカテゴリ名の両方を取得し、重複を除外**

例えば、products テーブルから商品名を、categories テーブルからカテゴリ名を取得し、重複する名前を一度だけ表示したい場合。

**事前データ:**

products テーブル (抜粋):

| product_name |
| :----------- |
| Laptop       |
| Electronics  |
| Mouse        |
| Smartphone   |
| (NULL)       |

categories テーブル (抜粋):

| category_name |
| :------------ |
| Electronics   |
| Peripherals   |
| Mobile        |
| Smartphone    |
| (NULL)        |

**SQL:**

```SQL
SELECT product_name FROM products
UNION
SELECT category_name FROM categories;
```

**実行結果:**

| name        |
| :---------- |
| Electronics |
| Laptop      |
| Mobile      |
| Mouse       |
| NULL        |
| Peripherals |
| Smartphone  |

この結果には、products と categories の共通の名前（Electronics, Smartphone）は一度だけ表示されます。また、どちらかのテーブルに NULL 値が存在する場合、UNION は NULL も一つの値として扱い、重複を除外します。

### **UNION ALL：和集合（重複保持）**

複数の SELECT 文の結果を結合し、**重複する行も全て含めて**返します。UNION よりも高速に動作することが多いため、重複排除が不要な場合はこちらを推奨します。

#### **基本構文**

```SQL
SELECT 列リスト FROM テーブル 1
UNION ALL
SELECT 列リスト FROM テーブル 2;
```

#### **例: 全ての商品名とカテゴリ名を全て取得（重複も保持）**

事前データ:
（UNION の例と同じデータを使用）
**SQL:**

```SQL
SELECT product_name FROM products
UNION ALL
SELECT category_name FROM categories;
```

**実行結果:**

| name        |
| :---------- |
| Laptop      |
| Electronics |
| Mouse       |
| Smartphone  |
| NULL        |
| Electronics |
| Peripherals |
| Mobile      |
| Smartphone  |
| NULL        |

この結果には、products と categories の全ての名前が、重複も含めて表示されます。

### **INTERSECT：積集合 (実務での重要度：低)**

複数の SELECT 文の結果に**共通して存在する行のみ**を返します。

#### **基本構文**

```SQL
SELECT 列リスト FROM テーブル 1
INTERSECT
SELECT 列リスト FROM テーブル 2;
```

#### **例: 商品名とカテゴリ名で共通する名前を取得**

事前データ:
（UNION の例と同じデータを使用）
**SQL:**

```SQL
SELECT product_name FROM products
INTERSECT
SELECT category_name FROM categories;
```

**実行結果:**

| name        |
| :---------- |
| Electronics |
| Smartphone  |

もし products テーブルに'Electronics'という名前の商品があり、categories テーブルにも'Electronics'というカテゴリ名があれば、その行だけが結果として表示されます。同様に Smartphone も共通なので表示されます。

### **EXCEPT / MINUS：差集合 (実務での重要度：低)**

最初の SELECT 文の結果から、2 番目の SELECT 文の結果に**存在しない行のみ**を返します。

- **EXCEPT**: PostgreSQL、SQL Server などで使用されます。
- **MINUS**: Oracle で使用されます。

#### **基本構文**

```SQL
-- PostgreSQL / SQL Server
SELECT 列リスト FROM テーブル 1
EXCEPT
SELECT 列リスト FROM テーブル 2;

-- Oracle
SELECT 列リスト FROM テーブル 1
MINUS
SELECT 列リスト FROM テーブル 2;
```

#### **例: products テーブルに存在するが、categories テーブルには存在しない名前を取得**

事前データ:
（UNION の例と同じデータを使用）
**SQL:**

```SQL
SELECT product_name FROM products
EXCEPT
SELECT category_name FROM categories;
```

**実行結果:**

| name   |
| :----- |
| Laptop |
| Mouse  |

この結果には、'Laptop'や'Mouse'のように、商品名としては存在するがカテゴリ名としては存在しない名前だけが表示されます。

#### **💡 コラム: EXCEPT / MINUS がサポートされない RDBMS (MySQL の例)**

MySQL では EXCEPT や MINUS は直接サポートされていません。同等の結果を得るには、LEFT JOIN と WHERE IS NULL、または NOT EXISTS を組み合わせる方法が一般的です。

```SQL
-- MySQL などで EXCEPT の代替として使用
SELECT p.product_name
FROM products AS p
LEFT JOIN categories AS c ON p.product_name = c.category_name
WHERE c.category_name IS NULL;

-- または NOT EXISTS を使用
SELECT p.product_name
FROM products AS p
WHERE NOT EXISTS (SELECT 1 FROM categories AS c WHERE c.category_name \= p.product_name);
```

### **JOIN と 集合演算の使い分け**

- **JOIN**: 異なるテーブルの**関連する列**を**水平に**結合して、**行を拡張**する場合に使用します。通常、データモデルで定義されたリレーションシップ（外部キーなど）に基づいてデータを組み合わせる際に使います。
- **集合演算 (UNION, INTERSECT, EXCEPT)**: 複数の SELECT 文の**結果セット全体**を**垂直に**結合して、**行を追加**する場合に使用します。各クエリの列構成が同じである必要があります。異なるテーブルから似たような形式のデータをまとめて表示したい場合などに使います。

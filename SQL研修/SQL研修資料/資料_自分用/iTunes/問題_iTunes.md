## PostgreSQL spotify

- 環境変数設定（されてなければ）

> C:\Program Files\PostgreSQL\17\bin

---

- ターミナルを立ち上げて、sql ファイルがある場所までディレクトリを移動する（win+x）

> cd sql ファイルのあるディレクトリパス

- ローカルの sql サーバーに接続する（パスワードは aevic のはず）

> psql -h localhost -p 5432 -U postgres -d postgres

- データベース作成

> CREATE DATABASE mydb;

- データベースの一覧を確認する

> \l

- 新しいデータベースに接続する

> \c mydb

- sql ファイルを流し込む

> \i Chinook_PostgreSql_SerialPKs.sql

- 接続を切る

> \q

### 問題 1: 各アーティストのアルバム数と総曲数を取得してください。

**回答:**

---

### 問題 2: 2021 年以降に最も多くの顧客が購入したジャンルを上位 5 つ取得してください。

**ヒント:** `EXTRACT(YEAR FROM date_column)` を使用して年を抽出できます。

**回答:**

---

### 問題 3: 各従業員の顧客サポート売上合計と、全従業員の平均売上に対する比率を計算してください。

**ヒント:** ウィンドウ関数 `SUM(...) OVER ()` で全体の合計を求められます。

**回答:**

---

### 問題 4: 各顧客の最初の購入日と最後の購入日、およびその間の購入回数を取得してください。

**回答:**

---

### 問題 5: アルバムに複数のジャンルが含まれているアルバムのタイトルと、含まれるジャンル数を取得してください。

**回答:**

---

### 問題 6: 各国で最も売上が高かったジャンルと、その国の総売上におけるそのジャンルの売上比率を取得してください。

**ヒント:** サブクエリとウィンドウ関数を組み合わせて、国ごとのジャンル売上と国ごとの総売上を計算し、比率を求めます。`RANK()` または `ROW_NUMBER()` を使用して、各国のトップジャンルを特定できます。

**回答:**

---

### 問題 7: 過去 12 ヶ月間での各顧客の月ごとの購入金額と、その顧客の月平均購入金額からの乖離率を計算してください。

**ヒント:** `DATE_TRUNC('month', date_column)` で日付を月初に丸められます。ウィンドウ関数 `AVG(...) OVER (PARTITION BY customer_id)` で顧客ごとの月平均を計算し、`LAG()` や `LEAD()` を使わずに直接計算できます。

**回答:**

---

### 問題 8: 各国の顧客のうち、最も購入金額が高かった顧客の氏名と購入金額、およびその国の全顧客の平均購入金額を取得してください。

**回答:**

---

### 問題 9: 全てのプレイリストに含まれる曲の数と、そのうち複数のプレイリストに含まれる曲の数を取得してください。

**ヒント:** `UNION ALL` と `GROUP BY` を組み合わせて、全曲数と重複曲数を計算できます。

**回答:**

---

### 問題 10: 各アルバムの最長トラック名、最短トラック名、平均トラック長（ミリ秒）を取得してください。

**回答:**

---

### 問題 11: 各従業員の直接の上司の名前と、その上司が管理している従業員の数を取得してください。

**回答:**

---

### 問題 12: 顧客ごとの購入履歴で、前回購入時からの経過日数と累積購入金額を取得してください。

**ヒント:** ウィンドウ関数 `LAG()` と `SUM(...) OVER (ORDER BY ...)` を使用します。経過日数は `EXTRACT(DAY FROM (current_date - previous_date))` や `(current_date::date - previous_date::date)` で計算できます。

**回答:**

---

### 問題 13: 各メディアタイプで最も売上が高かったトラックの名称と、その売上金額を取得してください。

**回答:**

---

### 問題 14: 2020 年以降に全く購入がない顧客の氏名とメールアドレスを取得してください。

**回答:**

---

### 問題 15: 各ジャンルで最も平均トラック長が短いアルバムのタイトルと、その平均トラック長を取得してください。

**回答:**

---

### 問題 16: 各アーティストのアルバムごとの売上合計と、そのアーティストの総売上に対する比率を計算してください。

**回答:**

---

### 問題 17: 2022 年に購入があった顧客と、2023 年に購入があった顧客の両方に共通する顧客の氏名とメールアドレスを取得してください。

**回答:**

---

### 問題 18: 各顧客が購入した最も高価なトラックと最も安価なトラックの名前、およびそれらの単価を取得してください。

**回答:**

---

### 問題 19: 従業員の直属の上司の名前、さらにその上司の名前（存在する場合）を最大 3 階層まで取得してください。

**ヒント:** 複数回の自己結合（Self-Join）を使用します。

**回答:**

---

### 問題 20: 各ジャンルで最も人気のある（最も売上合計が高い）トラックのタイトルと、その売上合計を取得してください。

**回答:**

---

### 問題 21: 各顧客の購入総額が、その顧客の居住国における平均購入総額よりも高い顧客の氏名、国、購入総額、および国の平均購入総額を取得してください。

**回答:**

---

### 問題 22: 過去 3 ヶ月以内に購入があった顧客と、一度も購入がない顧客の情報をそれぞれ取得し、結合して表示してください。

**ヒント:** `UNION` を使用します。

**回答:**

---

### 問題 23: 各顧客が購入した総トラック数、総アルバム数、総アーティスト数を取得してください。

**回答:**

---

### 問題 24: 各従業員の入社年ごとの売上合計と、全従業員の入社年ごとの売上合計に対する比率を計算してください。

**回答:**

---

### 問題 25: 各トラックの購入頻度（購入された回数）と、そのトラックがプレイリストに追加された回数を取得してください。

**回答:**

---

### 問題 26: 各国で、最も多くの顧客が居住している都市と、その都市の顧客数を取得してください。

**回答:**

---

### 問題 27: 各顧客の購入履歴において、連続して同じジャンルの曲を購入した回数と、そのジャンル名を取得してください。

**ヒント:** ウィンドウ関数 `LAG()` と `CASE` 文を組み合わせて連続購入を検出します。

**回答:**

---

### 問題 28: 各顧客が購入した最も多いジャンルと、そのジャンルにおける購入金額合計を取得してください。

**回答:**

---

### 問題 29: 全従業員の平均給与（架空で、ここでは売上合計とする）よりも多くの売上を上げた従業員の氏名と売上合計、および平均売上を取得してください。

**回答:**

---

### 問題 30: 各アルバムに属するトラックのうち、最も高価なトラックと最も安価なトラックの名前と価格、そしてアルバムの総価格（全トラックの単価合計）を取得してください。

**回答:**

---

### 問題 31: 各顧客の購入総額が、全体の上位 20%に入る顧客の氏名と購入総額を取得してください。

**ヒント:** `NTILE()` ウィンドウ関数を使用してデータを分位に分割します。

**回答:**

---

### 問題 32: 各国の顧客ごとの購入金額について、その国の購入金額の合計に対する割合を計算し、さらにその顧客がその国で何番目に購入金額が高いかを取得してください。

**回答:**

---

### 問題 33: プレイリストに含まれていないトラックと、購入されたことがないトラックの両方を結合して取得してください。

**回答:**

---

### 問題 34: 各顧客の最初の購入から 30 日間の購入総額と、その期間中に購入したユニークなトラック数を取得してください。

**ヒント:** `MIN(invoice_date) OVER (PARTITION BY customer_id)` で最初の購入日を特定し、日付計算を行います。

**回答:**

---

### 問題 35: 各アーティストのアルバムの中で、平均トラック長が最も長いアルバムのタイトルと、その平均トラック長を取得してください。

**回答:**

---

### 問題 36: 各ジャンルのトラックのうち、単価がそのジャンルの平均単価よりも高いトラックのタイトル、ジャンル名、単価、およびジャンルの平均単価を取得してください。

**回答:**

---

### 問題 37: 各年の四半期ごとの総売上と、前年同四半期からの成長率を計算してください。

**ヒント:** `EXTRACT(YEAR FROM date_column)` と `EXTRACT(QUARTER FROM date_column)` で年と四半期を抽出します。`LAG()` ウィンドウ関数で前年同四半期の売上を取得します。

**回答:**

---

### 問題 38: 2020 年以前に作成されたプレイリストにのみ含まれるトラックと、2021 年以降に作成されたプレイリストにのみ含まれるトラックをそれぞれ取得してください。

**ヒント:** `EXCEPT` 集合演算子とサブクエリを使用します。プレイリストの作成日情報がないため、ここではトラックがプレイリストに追加された日付（invoice_date）の年で代替するか、より単純に「プレイリスト A には含まれるがプレイリスト B には含まれない」といった論理で解釈します。ここでは、トラックがプレイリストに追加された日を考慮しない、純粋なプレイリスト包含の有無で考えます。

**回答:**

**補足:** `playlist` テーブルに作成日 (`created_date` など) がないため、この問題は「2020 年以前に作成されたプレイリスト」という条件を満たすことができません。上記の回答は、「特定の条件を持つプレイリストにのみ含まれるトラック」という解釈で記述しています。もし`playlist`テーブルに日付情報があれば、その情報を使って絞り込みが可能です。

---

### 問題 39: 各顧客の購入品目において、最も購入回数が多いトラックを特定し、そのトラックの名称と購入回数を取得してください。

**回答:**

---

### 問題 40: 各顧客が購入した総金額が、その顧客の担当サポート担当者の管理する全顧客の平均購入金額よりも高い顧客の氏名、総金額、およびサポート担当者の管理する顧客の平均購入金額を取得してください。

**回答:**

---

### 問題 41: 各顧客の購入履歴で、購入金額がその顧客の過去の購入の最大金額を上回った回数を取得してください。

**ヒント:** ウィンドウ関数 `MAX(...) OVER (ORDER BY ... ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING)` を使用して、現在の行より前の最大値を取得します。

**回答:**

---

### 問題 42: 各ジャンルに属するアルバムの総数と、そのジャンルに属するトラックの平均ミリ秒を取得してください。

**回答:**

---

### 問題 43: 2020 年、2021 年、2022 年の各年に最も売上が高かった国と、その国の売上合計をそれぞれ取得してください。

**回答:**

---

### 問題 44: 全ての顧客が少なくとも一度は購入したことがあるトラックの名前を取得してください。

**ヒント:** `INTERSECT` を使用し、各顧客が購入したトラックの集合を結合します。または、`GROUP BY` と `HAVING COUNT(DISTINCT customer_id)` を使用して、全顧客数を満たすトラックを特定します。

**回答:**

---

### 問題 45: 各メディアタイプにおいて、最も多くのトラックが属するジャンルと、そのジャンルに属するトラック数を取得してください。

**回答:**

---

### 問題 46: 各顧客の購入総額が、全体の上位 10%または下位 10%に入る顧客の氏名と購入総額を取得してください。

**ヒント:** `NTILE()` ウィンドウ関数を使用します。

**回答:**

---

### 問題 47: 各従業員について、彼らがサポートする顧客の中で最も購入回数が多い顧客と、その購入回数を取得してください。

**回答:**

---

### 問題 48: 顧客が過去の購入で最も多く使用した請求国（billing_country）と、その国の購入回数を取得してください。

**回答:**

---

### 問題 49: 各アルバムのリリース年（架空で、最初のトラックの購入日を代用）と、そのアルバムの平均単価（全トラックの単価の平均）を取得してください。

**ヒント:** `MIN(invoice_date)` を使用して「リリース年」を近似します。

**回答:**

**補足:** `album` テーブルにリリース年情報がないため、ここではそのアルバムに含まれる**最も古いトラックの購入日**を「近似リリース年」としています。購入がないトラックやアルバムは年が表示されません。

---

承知いたしました。問題 50 を再度出力し、さらに 10 問（問題 51〜60）を追加で作成します。

---

### 問題 50: 顧客と従業員の両方で、同じ「city」に住んでいる人々の氏名と居住都市を結合して取得してください。

**ヒント:** `INTERSECT` を使用して共通の都市に住む人々を特定します。

**回答:**

---

### 問題 51: 各アーティストが作曲したトラックの総数と、それらのトラックが属するアルバムの平均トラック数を取得してください。

**回答:**

---

### 問題 52: 各顧客の最初の購入から 2 回目の購入までの期間（日数）を取得してください。2 回以上購入している顧客のみを対象とします。

**ヒント:** ウィンドウ関数 `LEAD()` または `LAG()` を使用して前後の購入日を比較します。

**回答:**

---

### 問題 53: 各顧客の総購入金額が、その顧客の居住国における購入金額の合計の上位 25%に入る顧客の氏名、国、購入総額を取得してください。

**ヒント:** `NTILE()` ウィンドウ関数とサブクエリを組み合わせます。

**回答:**

---

### 問題 54: 全てのトラックを対象に、そのトラックの単価がそのジャンルの平均単価と比較して、どれだけ高いか（または低いか）をパーセンテージで示してください。

**回答:**

---

### 問題 55: 各プレイリストに含まれるトラックの中で、最も長いトラックの名称と、最も短いトラックの名称を取得してください。

**回答:**

---

### 問題 56: 各国の顧客の売上合計が、全世界の平均顧客売上合計よりも高い国とその売上合計、および全世界の平均顧客売上合計を取得してください。

**回答:**

---

### 問題 57: 各従業員がサポートする顧客の中で、最も年齢が若い顧客と最も年齢が高い顧客の氏名と生年月日を取得してください。

**ヒント:** 顧客テーブルには生年月日がないため、ここでは「Customer ID」が最も小さい/大きい顧客を「若い/年上」と仮定します。または、より現実的なデータとして、購買日を基準に「最新の購買顧客」と「最も古い購買顧客」を「若い/年上」と見なすこともできます。ここでは後者のアプローチで「最新の購入顧客」と「最も古い購入顧客」と解釈します。

**回答:**

---

### 問題 58: 各トラックについて、それが最も多く購入された国と、その国での購入回数を取得してください。

**回答:**

---

### 問題 59: 各顧客の購入総額が、その顧客の担当サポート担当者の**直属の上司**が管理する全顧客の平均購入金額よりも高い顧客の氏名、総金額、担当サポート担当者名、および上司が管理する顧客の平均購入金額を取得してください。

**回答:**

---

### 問題 60: 各年ごとの総売上が最も高い月と、その月の売上金額、そしてその年の総売上に対する比率を取得してください。

**ヒント:** `EXTRACT(YEAR FROM date)` と `EXTRACT(MONTH FROM date)` を使用し、ウィンドウ関数で月ごとの売上と年ごとの総売上を計算します。

**回答:**

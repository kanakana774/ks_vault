### 単元 2. case 式/集計関数と group by/DDL

**問題 1**
`track` テーブルから、`unit_price` ごとにトラックの数をカウントし、結果を `unit_price` の昇順で表示してください。

**回答**

```sql
SELECT unit_price, COUNT(track_id) AS track_count
FROM track
GROUP BY unit_price
ORDER BY unit_price;
```

---

**問題 2**
`invoice_line` テーブルを使用して、各 `invoice_id` ごとに購入されたアイテムの合計数量 (`quantity`) を計算してください。

**回答**

```sql
SELECT invoice_id, SUM(quantity) AS total_quantity
FROM invoice_line
GROUP BY invoice_id;
```

---

**問題 3**
`customer` テーブルから、各 `country` ごとに顧客の数をカウントし、顧客数が 2 人以上の国のみを表示してください。

**回答**

```sql
SELECT country, COUNT(customer_id) AS customer_count
FROM customer
GROUP BY country
HAVING COUNT(customer_id) >= 2;
```

---

**問題 4**
`track` テーブルから、各 `genre_id` ごとにトラックの平均価格 (`unit_price`) を計算し、小数点以下 2 桁で丸めて表示してください。

**回答**

```sql
SELECT genre_id, ROUND(AVG(unit_price), 2) AS average_price
FROM track
GROUP BY genre_id;
```

---

**問題 5**
`employee` テーブルから、各 `title` ごとに従業員の最大年齢と最小年齢を計算してください。年齢は現在の年から `birth_date` の年を引いたものとします。

**回答**

```sql
SELECT
    title,
    MAX(EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date)) AS max_age,
    MIN(EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM birth_date)) AS min_age
FROM employee
GROUP BY title;
```

**別パターン (DATE_PART 関数を使用)**

```sql
SELECT
    title,
    MAX(DATE_PART('year', CURRENT_DATE) - DATE_PART('year', birth_date)) AS max_age,
    MIN(DATE_PART('year', CURRENT_DATE) - DATE_PART('year', birth_date)) AS min_age
FROM employee
GROUP BY title;
```

---

**問題 6**
`invoice` テーブルから、`total` の値に基づいて請求書を分類するクエリを作成してください。

- `total` が `5.00` 未満の場合は 'Small'
- `total` が `5.00` 以上 `10.00` 未満の場合は 'Medium'
- `total` が `10.00` 以上 `15.00` 未満の場合は 'Large'
- それ以外は 'Extra Large'

結果として `invoice_id`, `total`, `invoice_category` を表示してください。

**回答**

```sql
SELECT
    invoice_id,
    total,
    CASE
        WHEN total < 5.00 THEN 'Small'
        WHEN total >= 5.00 AND total < 10.00 THEN 'Medium'
        WHEN total >= 10.00 AND total < 15.00 THEN 'Large'
        ELSE 'Extra Large'
    END AS invoice_category
FROM invoice;
```

---

**問題 7**
`customer` テーブルから、各 `support_rep_id` ごとに顧客の数をカウントし、サポート担当者 ID を持たない顧客も表示してください。

**回答**

```sql
SELECT support_rep_id, COUNT(customer_id) AS customer_count
FROM customer
GROUP BY support_rep_id;
```

---

**問題 8**
`track` テーブルから、`milliseconds` の値に基づいてトラックの長さを分類するクエリを作成してください。

- `milliseconds` が `180000` (3 分) 未満の場合は 'Short'
- `milliseconds` が `180000` 以上 `300000` (5 分) 未満の場合は 'Medium'
- それ以外は 'Long'

結果として `track_id`, `name`, `milliseconds`, `track_length_category` を表示してください。

**回答**

```sql
SELECT
    track_id,
    name,
    milliseconds,
    CASE
        WHEN milliseconds < 180000 THEN 'Short'
        WHEN milliseconds >= 180000 AND milliseconds < 300000 THEN 'Medium'
        ELSE 'Long'
    END AS track_length_category
FROM track;
```

---

**問題 9**
`invoice_line` テーブルから、`track_id` ごとに販売された合計数量 (`quantity`) を計算し、合計数量が `20` 以上のトラックのみを表示してください。

**回答**

```sql
SELECT track_id, SUM(quantity) AS total_sold_quantity
FROM invoice_line
GROUP BY track_id
HAVING SUM(quantity) >= 20;
```

---

**問題 10**
`artist` テーブルの `name` カラムのデータ型を `VARCHAR(200)` に変更してください。

**回答**

```sql
ALTER TABLE artist
ALTER COLUMN name TYPE VARCHAR(200);
```

---

**問題 11**
`album` テーブルに `release_year` という名前の `INT` 型の新しいカラムを追加してください。

**回答**

```sql
ALTER TABLE album
ADD COLUMN release_year INT;
```

---

**問題 12**
`customer` テーブルから、`company` が NULL である顧客と NULL でない顧客の数をそれぞれカウントしてください。

**回答**

```sql
SELECT
    CASE
        WHEN company IS NULL THEN 'No Company'
        ELSE 'Has Company'
    END AS company_status,
    COUNT(customer_id) AS customer_count
FROM customer
GROUP BY company_status;
```

---

**問題 13**
`track` テーブルから、`album_id` と `genre_id` の組み合わせごとに、トラックの最小価格と最大価格を表示してください。

**回答**

```sql
SELECT album_id, genre_id, MIN(unit_price) AS min_price, MAX(unit_price) AS max_price
FROM track
GROUP BY album_id, genre_id
ORDER BY album_id, genre_id;
```

---

**問題 14**
`invoice` テーブルの `billing_state` カラムの名前を `state_province` に変更してください。

**回答**

```sql
ALTER TABLE invoice
RENAME COLUMN billing_state TO state_province;
```

---

**問題 15**
`playlist` テーブルに `description` という名前の `TEXT` 型の新しいカラムを追加し、その後そのカラムを削除してください。

**回答**

```sql
-- カラムの追加
ALTER TABLE playlist
ADD COLUMN description TEXT;

-- カラムの削除
ALTER TABLE playlist
DROP COLUMN description;
```

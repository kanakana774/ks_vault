集計とグループ化に関する問題

## 問題 1: 全商品数とカテゴリ数

### 重要度: ★★★★

### 問題目的: COUNT(\_)と COUNT(DISTINCT 列名)を使用して、テーブルの全行数と重複を除いた要素数をカウントする方法を理解する。

## 問題:

products_mst テーブルに登録されている全商品数をカウントしてください。
products_mst テーブルに登録されているユニークなカテゴリ数をカウントしてください。

### 答え:

全商品数

```SQL
SELECT COUNT(*) AS total_products
FROM products_mst;
```

ユニークなカテゴリ数

```SQL
SELECT COUNT(DISTINCT category) AS unique_categories
FROM products_mst;
```

## 問題 2: 商品の合計価格と平均価格

### 重要度: ★★★★

### 問題目的: SUM()と AVG()を使用して、数値列の合計値と平均値を算出する方法を理解する。

## 問題: products_mst テーブルに登録されている全商品の価格の合計と平均価格をそれぞれ算出してください。

### 答え:

```SQL
SELECT
	SUM(PRICE) AS TOTAL_PRICE,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST;
```

## 問題 3: 最も安い商品と最も高い商品の価格

### 重要度: ★★★★

### 問題目的: MIN()と MAX()を使用して、列の最小値と最大値を特定する方法を理解する。

## 問題: products_mst テーブルから、最も安い商品の価格と最も高い商品の価格をそれぞれ取得してください。

### 答え:

```SQL
SELECT
	MIN(PRICE) AS MIN_PRODUCT_PRICE,
	MAX(PRICE) AS MAX_PRODUCT_PRICE
FROM
	PRODUCTS_MST;
```

## 問題 4: カテゴリごとの商品数と平均価格

### 重要度: ★★★★★

### 問題目的: GROUP BY 句を使用して、特定の列（カテゴリ）でデータをグループ化し、グループごとに集計関数を実行する方法を理解する。

## 問題: products_mst テーブルから、カテゴリごとに商品数と平均価格を算出してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
GROUP BY
	CATEGORY;
```

## 問題 5: 高価格帯の商品が多いカテゴリを特定する

### 重要度: ★★★★★

### 問題目的: HAVING 句を使用して、GROUP BY で集計された結果に対して条件を指定し、フィルタリングする方法を理解する。

## 問題: products_mst テーブルから、平均価格が 5000 円より大きいカテゴリを抽出し、そのカテゴリ名、商品数、平均価格を表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
GROUP BY
	CATEGORY
HAVING
	AVG(PRICE) > 5000;
```

## 問題 6: 在庫が特定の数量以上の商品のカテゴリ別集計

### 重要度: ★★★★★

### 問題目的: WHERE 句で集計前の行フィルタリングを行い、その後に GROUP BY と HAVING を組み合わせて集計後のグループをフィルタリングする処理順序を理解する。

## 問題: products_mst テーブルから、在庫数(stock_quantity)が 100 個以上の商品のみを対象に、カテゴリごとの商品数を算出してください。ただし、商品数が 2 つ以上のカテゴリのみを表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT
FROM
	PRODUCTS_MST
WHERE
	STOCK_QUANTITY >= 100 -- まず、在庫数 100 個以上の商品に絞り込む
GROUP BY
	CATEGORY
HAVING
	COUNT(*) >= 2; -- その後、グループ化された結果で商品数が 2 つ以上のものを抽出
```

## 問題 7: 注文ごとの異なる商品点数と合計購入個数

### 重要度: ★★★★★

### 問題目的: COUNT(DISTINCT 列名)と SUM()を組み合わせて、各グループ内でユニークな要素の数と合計を算出する方法を理解する。

## 問題: order_details_trn テーブルから、注文 ID(order_id)ごとに異なる商品の種類数（商品点数）と、その注文における合計購入個数(quantity)を算出してください。

### 答え:

```SQL
SELECT
	ORDER_ID,
	COUNT(DISTINCT PRODUCT_ID) AS DISTINCT_PRODUCT_COUNT,
	SUM(QUANTITY) AS TOTAL_QUANTITY_ORDERED
FROM
	ORDER_DETAILS_TRN
GROUP BY
	ORDER_ID;
```

補足：そもそも order_id と product_id が複合 pk なので、COUNT(DISTINCT PRODUCT_ID)の distinct が機能することはない。
そのため、なくてもいいかも。

## 問題 8: 顧客の登録年ごとの顧客数

### 重要度: ★★★★

### 問題目的: EXTRACT()関数で日付から年を抽出し、その年でグループ化して集計を行う方法を理解する。

## 問題: customers_mst テーブルから、顧客の登録年(created_date)ごとに登録された顧客の数を算出してください。

### 答え:

```SQL
SELECT
	EXTRACT(
		YEAR
		FROM
			CREATED_DATE
	) AS REGISTRATION_YEAR,
	COUNT(*) AS CUSTOMER_COUNT
FROM
	CUSTOMERS_MST
GROUP BY
	REGISTRATION_YEAR
ORDER BY
	REGISTRATION_YEAR;
```

補足：REGISTRATION_YEAR エイリアスを group by で使用できてる件について。

- 多くの DBMS: GROUP BY 句では SELECT で定義したエイリアスは使用できない。
- PostgreSQL: GROUP BY 句で SELECT のエイリアスを使用できる。これは、PostgreSQL が内部的にエイリアスを元の式に置き換えているため。

## 問題 9: 注文から 90 日後の日付を計算し、月別で集計

### 重要度: ★★★★★

### 問題目的: 日付の加算と EXTRACT()関数、GROUP BY を組み合わせ、計算後の日付で集計する方法を理解する。

## 問題: orders_trn テーブルから、各注文の注文日から 90 日後の日付を計算してください。その上で、その「90 日後の日付」の月ごとに、該当する注文の数を算出してください。

### 答え:

```SQL
SELECT
	EXTRACT(
		MONTH
		FROM
			(ORDER_DATE + INTERVAL '90 day')
	) AS CALCULATED_MONTH,
	COUNT(*) AS ORDERS_COUNT
FROM
	ORDERS_TRN
GROUP BY
	CALCULATED_MONTH
ORDER BY
	CALCULATED_MONTH;
```

## 問題 xx: 平均価格が高く、かつ特定の高価格帯の商品を含むカテゴリの抽出

### 重要度: ★★★★★

### 問題目的: WHERE 句と HAVING 句をより複雑に組み合わせ、集計前と集計後の両方で条件を適用する。

## 問題: products_mst テーブルから、価格が 10000 円より高い商品が少なくとも 1 つ含まれるカテゴリで、かつそのカテゴリの平均価格が 15000 円より大きいものを抽出し、カテゴリ名、商品数、平均価格を表示してください。

### 答え:

```SQL
SELECT
	CATEGORY,
	COUNT(*) AS PRODUCT_COUNT,
	AVG(PRICE) AS AVERAGE_PRICE
FROM
	PRODUCTS_MST
WHERE
	PRODUCT_ID IN (
		SELECT
			PRODUCT_ID
		FROM
			PRODUCTS_MST
		WHERE
			PRICE > 10000
	) -- 価格が 10000 円より高い商品が含まれるカテゴリを対象とする（集計前のフィルタリング）
GROUP BY
	CATEGORY
HAVING
	AVG(PRICE) > 15000;

-- 集計後の平均価格でフィルタリング
```

補足: この問題はサブクエリを使用していますが、集計とグループ化の理解を深めるために重要です。WHERE 句で先に特定の条件を満たす行を絞り込むことで、GROUP BY と HAVING の処理が効率化されることを示唆しています。
